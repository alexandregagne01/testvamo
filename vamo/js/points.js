import*as THREE from"../three/three.module.js";let pointer=new THREE.Vector2,groupePointsInteret=new THREE.Group,decomptePointAuProchainClic=0,groupeFichierModele,paramsCourant,afficher,camera,pointTaille,pointDecalage;function pointsInit(e,t,n,i,o,r){groupeFichierModele=e,paramsCourant=t,afficher=n,camera=i,pointTaille=o,pointDecalage=r,groupePointsInteret.name="groupePointsInteret",document.addEventListener("mousemove",onMouseMove),document.addEventListener("click",onClick)}function onMouseMove(e){1<paramsCourant.niveauMenu&&(pointer.x=e.clientX/window.innerWidth*2-1,pointer.y=2*-(e.clientY/window.innerHeight)+1)}function onClick(e){2==decomptePointAuProchainClic?decomptePointAuProchainClic=1:1==decomptePointAuProchainClic&&(decomptePointAuProchainClic=0,pointer.x=e.clientX/window.innerWidth*2-1,pointer.y=2*-(e.clientY/window.innerHeight)+1,ajouterUnPoint())}function ajouterUnPointProchainClic(){decomptePointAuProchainClic=2}function supprimerDernierPoint(){var e=paramsCourant.pointsInteret.length;0<e&&(paramsCourant.pointsInteret.splice(e-1,1),chargerTousLesPointsInteret(),afficher())}function effacerTousLesPoints(){confirm("Effacer TOUS les points d'intérêt ?")&&(paramsCourant.pointsInteret=[],chargerTousLesPointsInteret(),afficher())}let monCercle=void 0;function getCercle(){var e=document.createElement("canvas"),t=(e.width=e.height=64,e.getContext("2d"));return t.fillStyle="white",t.beginPath(),t.ellipse(32,32,16,16,0,0,2*Math.PI),t.fill(),t.strokeStyle="black",t.lineWidth=4,t.beginPath(),t.ellipse(32,32,16,16,0,0,2*Math.PI),t.stroke(),new THREE.CanvasTexture(e)}function getEtiq(e){var t=document.createElement("canvas"),n=(t.width=t.height=64,t.getContext("2d"));return n.fillStyle="#2222ff",n.fillStyle="#1111ff",n.fillRect(0,0,t.width,t.height),n.fillStyle="#ffff00",n.font="40px serif",n.textAlign="center",n.fillText((e+1).toString(),32,48),new THREE.CanvasTexture(t)}function ajouterCePoint(e,t,n,i){null==monCercle&&(monCercle=getCercle());var o=new THREE.SpriteMaterial({map:monCercle}),o=new THREE.Sprite(o),o=(o.position.set(t,n,i),o.scale.set(pointTaille,pointTaille,pointTaille),groupePointsInteret.add(o),new THREE.Vector3(t,n,i).normalize()),e=getEtiq(e),e=new THREE.SpriteMaterial({map:e}),e=new THREE.Sprite(e),e=(e.position.set(o.x,o.y,o.z),e.scale.set(.05,.05,.05),groupePointsInteret.add(e),new THREE.LineDashedMaterial({scale:10,linewidth:10,dashSize:10,gapSize:4,color:5592473})),r=[],t=(r.push(new THREE.Vector3(t,n,i)),r.push(o),(new THREE.BufferGeometry).setFromPoints(r)),n=new THREE.Line(t,e);groupePointsInteret.add(n)}function ajouterUnPoint(){var e=new THREE.Raycaster,n=(e.setFromCamera(pointer,camera),e.intersectObjects(groupeFichierModele.children));if(0<n.length){let e=null,t;for(t=0;t<n.length;t++)if(null!=n[t].face){(null==e||e.distance>n[t].distance)&&(e=n[t]);break}if(null!=e){new THREE.PointsMaterial({color:"white",sizeAttenuation:!1,size:10}),new THREE.BufferGeometry;let i=[e.point.x+pointDecalage*e.face.normal.x,e.point.y+pointDecalage*e.face.normal.y,e.point.z+pointDecalage*e.face.normal.z],o=100,r=0;paramsCourant.pointsInteret.forEach(function(e,t,n){e=Math.pow(e[0]-i[0],2)+Math.pow(e[1]-i[1],2)+Math.pow(e[2]-i[2],2);o>e&&(o=e,r=t)}),o<5e-4?(paramsCourant.pointsInteret.splice(r,1),chargerTousLesPointsInteret()):(i=i.map(e=>parseFloat(e.toFixed(6))),paramsCourant.pointsInteret.push(i),ajouterCePoint(paramsCourant.pointsInteret.length-1,i[0],i[1],i[2])),afficher()}}}function chargerTousLesPointsInteret(){groupePointsInteret.clear(),paramsCourant.pointsInteret.forEach(function(e,t,n){ajouterCePoint(t,e[0],e[1],e[2])})}export{groupePointsInteret,pointsInit,ajouterUnPointProchainClic,supprimerDernierPoint,effacerTousLesPoints,ajouterUnPoint,chargerTousLesPointsInteret};