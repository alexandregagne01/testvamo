import*as THREE from"../three/three.module.js";import{VRButton}from"../three/webxr/VRButton.js";import{XRControllerModelFactory}from"../three/webxr/XRControllerModelFactory.js";let controller1,controller2,controllerGrip1,controllerGrip2,raycaster;const intersected=[],tempMatrix=new THREE.Matrix4;let controls,scene,groupeFichierModele,groupeFichierEtAnnotations,afficher;function webxrInit(e,t,r,n,o,i,l){scene=e,groupeFichierModele=n,groupeFichierEtAnnotations=o,afficher=i;e=VRButton.createButton(t),document.body.appendChild(e),t.xr.enabled=!0,t.xr.addEventListener("sessionstart",function(){groupeFichierEtAnnotations.position.set(0,1,-1),t.setAnimationLoop(afficher)}),t.xr.addEventListener("sessionend",function(){groupeFichierEtAnnotations.position.set(0,0,0),t.setAnimationLoop(null),l.reset(),afficher()}),(controller1=t.xr.getController(0)).addEventListener("selectstart",onSelectStart),controller1.addEventListener("selectend",onSelectEnd),scene.add(controller1),(controller2=t.xr.getController(1)).addEventListener("selectstart",onSelectStart),controller2.addEventListener("selectend",onSelectEnd),scene.add(controller2),n=new XRControllerModelFactory,(controllerGrip1=t.xr.getControllerGrip(0)).add(n.createControllerModel(controllerGrip1)),scene.add(controllerGrip1),(controllerGrip2=t.xr.getControllerGrip(1)).add(n.createControllerModel(controllerGrip2)),scene.add(controllerGrip2),o=(new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,-1)]),i=new THREE.Line(o);i.name="line",i.scale.z=5,controller1.add(i.clone()),controller2.add(i.clone()),raycaster=new THREE.Raycaster}function buildController(e){let t,r;switch(e.targetRayMode){case"tracked-pointer":return(t=new THREE.BufferGeometry).setAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,0,-1],3)),t.setAttribute("color",new THREE.Float32BufferAttribute([.5,.5,.5,0,0,0],3)),r=new THREE.LineBasicMaterial({vertexColors:!0,blending:THREE.AdditiveBlending}),new THREE.Line(t,r);case"gaze":return t=new THREE.RingGeometry(.02,.04,32).translate(0,0,-1),r=new THREE.MeshBasicMaterial({opacity:.5,transparent:!0}),new THREE.Mesh(t,r)}}function onSelectStart(e){var e=e.target,t=getIntersections(e);0<t.length&&(t[0],t=groupeFichierEtAnnotations,e.attach(t),e.userData.selected=t)}function onSelectEnd(e){var t,e=e.target;void 0!==e.userData.selected&&(t=e.userData.selected,scene.attach(t),e.userData.selected=void 0)}function getIntersections(e){return tempMatrix.identity().extractRotation(e.matrixWorld),raycaster.ray.origin.setFromMatrixPosition(e.matrixWorld),raycaster.ray.direction.set(0,0,-1).applyMatrix4(tempMatrix),raycaster.intersectObjects(groupeFichierModele.children,!0)}function intersectObjects(e){var t,r;null!=e&&void 0===e.userData.selected&&null!=(t=e.getObjectByName("line"))&&(0<(e=getIntersections(e)).length?(r=(e=e[0]).object,intersected.push(r),t.scale.z=e.distance):t.scale.z=5)}function intersecterControleurs(){intersectObjects(controller1),intersectObjects(controller2)}function cleanIntersected(){for(;intersected.length;)intersected.pop()}export{webxrInit,intersecterControleurs};