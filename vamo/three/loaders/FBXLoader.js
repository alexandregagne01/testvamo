import{AmbientLight,AnimationClip,Bone,BufferGeometry,ClampToEdgeWrapping,Color,DirectionalLight,EquirectangularReflectionMapping,Euler,FileLoader,Float32BufferAttribute,Group,Line,LineBasicMaterial,Loader,LoaderUtils,MathUtils,Matrix3,Matrix4,Mesh,MeshLambertMaterial,MeshPhongMaterial,NumberKeyframeTrack,Object3D,OrthographicCamera,PerspectiveCamera,PointLight,PropertyBinding,Quaternion,QuaternionKeyframeTrack,RepeatWrapping,Skeleton,SkinnedMesh,SpotLight,Texture,TextureLoader,Uint16BufferAttribute,Vector3,Vector4,VectorKeyframeTrack,sRGBEncoding}from"../three.module.js";import*as fflate from"../libs/fflate.module.js";import{NURBSCurve}from"../curves/NURBSCurve.js";let fbxTree,connections,sceneGraph;class FBXLoader extends Loader{constructor(e){super(e)}load(t,r,e,a){const n=this,i=""===n.path?LoaderUtils.extractUrlBase(t):n.path;var o=new FileLoader(this.manager);o.setPath(n.path),o.setResponseType("arraybuffer"),o.setRequestHeader(n.requestHeader),o.setWithCredentials(n.withCredentials),o.load(t,function(e){try{r(n.parse(e,i))}catch(e){a?a(e):console.error(e),n.manager.itemError(t)}},e,a)}parse(e,t){if(isFbxFormatBinary(e))fbxTree=(new BinaryParser).parse(e);else{e=convertArrayBufferToString(e);if(!isFbxFormatASCII(e))throw new Error("THREE.FBXLoader: Unknown format.");if(getFbxVersion(e)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+getFbxVersion(e));fbxTree=(new TextParser).parse(e)}e=new TextureLoader(this.manager).setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);return new FBXTreeParser(e,this.manager).parse(fbxTree)}}class FBXTreeParser{constructor(e,t){this.textureLoader=e,this.manager=t}parse(){connections=this.parseConnections();var e=this.parseImages(),e=this.parseTextures(e),e=this.parseMaterials(e),t=this.parseDeformers(),r=(new GeometryParser).parse(t);return this.parseScene(t,r,e),sceneGraph}parseConnections(){const n=new Map;return"Connections"in fbxTree&&fbxTree.Connections.connections.forEach(function(e){var t=e[0],r=e[1],e=e[2],a=(n.has(t)||n.set(t,{parents:[],children:[]}),{ID:r,relationship:e}),a=(n.get(t).parents.push(a),n.has(r)||n.set(r,{parents:[],children:[]}),{ID:t,relationship:e});n.get(r).children.push(a)}),n}parseImages(){var e={},t={};if("Video"in fbxTree.Objects){var r=fbxTree.Objects.Video;for(const s in r){var a,n,i=r[s];e[parseInt(s)]=i.RelativeFilename||i.Filename,"Content"in i&&(n=i.Content instanceof ArrayBuffer&&0<i.Content.byteLength,a="string"==typeof i.Content&&""!==i.Content,(n||a)&&(n=this.parseImage(r[s]),t[i.RelativeFilename||i.Filename]=n))}}for(const l in e){var o=e[l];e[l]=void 0!==t[o]?t[o]:e[l].split("\\").pop()}return e}parseImage(e){var t=e.Content,r=e.RelativeFilename||e.Filename,a=r.slice(r.lastIndexOf(".")+1).toLowerCase();let n;switch(a){case"bmp":n="image/bmp";break;case"jpg":case"jpeg":n="image/jpeg";break;case"png":n="image/png";break;case"tif":n="image/tiff";break;case"tga":null===this.manager.getHandler(".tga")&&console.warn("FBXLoader: TGA loader not found, skipping ",r),n="image/tga";break;default:return void console.warn('FBXLoader: Image type "'+a+'" is not supported.')}return"string"==typeof t?"data:"+n+";base64,"+t:(e=new Uint8Array(t),window.URL.createObjectURL(new Blob([e],{type:n})))}parseTextures(e){var t=new Map;if("Texture"in fbxTree.Objects){var r=fbxTree.Objects.Texture;for(const n in r){var a=this.parseTexture(r[n],e);t.set(parseInt(n),a)}}return t}parseTexture(e,t){var t=this.loadTexture(e,t),r=(t.ID=e.id,t.name=e.attrName,e.WrapModeU),a=e.WrapModeV,r=void 0!==r?r.value:0,a=void 0!==a?a.value:0;return t.wrapS=0===r?RepeatWrapping:ClampToEdgeWrapping,t.wrapT=0===a?RepeatWrapping:ClampToEdgeWrapping,"Scaling"in e&&(r=e.Scaling.value,t.repeat.x=r[0],t.repeat.y=r[1]),"Translation"in e&&(a=e.Translation.value,t.offset.x=a[0],t.offset.y=a[1]),t}loadTexture(e,t){let r;var a=this.textureLoader.path,n=connections.get(e.id).children;void 0!==n&&0<n.length&&void 0!==t[n[0].ID]&&(0!==(r=t[n[0].ID]).indexOf("blob:")&&0!==r.indexOf("data:")||this.textureLoader.setPath(void 0));let i;t=e.FileName.slice(-3).toLowerCase();return i="tga"===t?null===(n=this.manager.getHandler(".tga"))?(console.warn("FBXLoader: TGA loader not found, creating placeholder texture for",e.RelativeFilename),new Texture):(n.setPath(this.textureLoader.path),n.load(r)):"psd"===t?(console.warn("FBXLoader: PSD textures are not supported, creating placeholder texture for",e.RelativeFilename),new Texture):this.textureLoader.load(r),this.textureLoader.setPath(a),i}parseMaterials(e){var t=new Map;if("Material"in fbxTree.Objects){var r=fbxTree.Objects.Material;for(const n in r){var a=this.parseMaterial(r[n],e);null!==a&&t.set(parseInt(n),a)}}return t}parseMaterial(e,t){var r=e.id,a=e.attrName;let n=e.ShadingModel;if("object"==typeof n&&(n=n.value),!connections.has(r))return null;e=this.parseParameters(e,t,r);let i;switch(n.toLowerCase()){case"phong":i=new MeshPhongMaterial;break;case"lambert":i=new MeshLambertMaterial;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',n),i=new MeshPhongMaterial}return i.setValues(e),i.name=a,i}parseParameters(e,r,t){const a={},n=(e.BumpFactor&&(a.bumpScale=e.BumpFactor.value),e.Diffuse?a.color=(new Color).fromArray(e.Diffuse.value):!e.DiffuseColor||"Color"!==e.DiffuseColor.type&&"ColorRGB"!==e.DiffuseColor.type||(a.color=(new Color).fromArray(e.DiffuseColor.value)),e.DisplacementFactor&&(a.displacementScale=e.DisplacementFactor.value),e.Emissive?a.emissive=(new Color).fromArray(e.Emissive.value):!e.EmissiveColor||"Color"!==e.EmissiveColor.type&&"ColorRGB"!==e.EmissiveColor.type||(a.emissive=(new Color).fromArray(e.EmissiveColor.value)),e.EmissiveFactor&&(a.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),e.Opacity&&(a.opacity=parseFloat(e.Opacity.value)),a.opacity<1&&(a.transparent=!0),e.ReflectionFactor&&(a.reflectivity=e.ReflectionFactor.value),e.Shininess&&(a.shininess=e.Shininess.value),e.Specular?a.specular=(new Color).fromArray(e.Specular.value):e.SpecularColor&&"Color"===e.SpecularColor.type&&(a.specular=(new Color).fromArray(e.SpecularColor.value)),this);return connections.get(t).children.forEach(function(e){var t=e.relationship;switch(t){case"Bump":a.bumpMap=n.getTexture(r,e.ID);break;case"Maya|TEX_ao_map":a.aoMap=n.getTexture(r,e.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":a.map=n.getTexture(r,e.ID),void 0!==a.map&&(a.map.encoding=sRGBEncoding);break;case"DisplacementColor":a.displacementMap=n.getTexture(r,e.ID);break;case"EmissiveColor":a.emissiveMap=n.getTexture(r,e.ID),void 0!==a.emissiveMap&&(a.emissiveMap.encoding=sRGBEncoding);break;case"NormalMap":case"Maya|TEX_normal_map":a.normalMap=n.getTexture(r,e.ID);break;case"ReflectionColor":a.envMap=n.getTexture(r,e.ID),void 0!==a.envMap&&(a.envMap.mapping=EquirectangularReflectionMapping,a.envMap.encoding=sRGBEncoding);break;case"SpecularColor":a.specularMap=n.getTexture(r,e.ID),void 0!==a.specularMap&&(a.specularMap.encoding=sRGBEncoding);break;case"TransparentColor":case"TransparencyFactor":a.alphaMap=n.getTexture(r,e.ID),a.transparent=!0;break;default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",t)}}),a}getTexture(e,t){return"LayeredTexture"in fbxTree.Objects&&t in fbxTree.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),t=connections.get(t).children[0].ID),e.get(t)}parseDeformers(){var e={},t={};if("Deformer"in fbxTree.Objects){var r=fbxTree.Objects.Deformer;for(const o in r){var a,n=r[o],i=connections.get(parseInt(o));"Skin"===n.attrType?((a=this.parseSkeleton(i,r)).ID=o,1<i.parents.length&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),a.geometryID=i.parents[0].ID,e[o]=a):"BlendShape"===n.attrType&&((a={id:o}).rawTargets=this.parseMorphTargets(i,r),a.id=o,1<i.parents.length&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),t[o]=a)}}return{skeletons:e,morphTargets:t}}parseSkeleton(e,r){const a=[];return e.children.forEach(function(e){var t=r[e.ID];"Cluster"===t.attrType&&(e={ID:e.ID,indices:[],weights:[],transformLink:(new Matrix4).fromArray(t.TransformLink.a)},"Indexes"in t&&(e.indices=t.Indexes.a,e.weights=t.Weights.a),a.push(e))}),{rawBones:a,bones:[]}}parseMorphTargets(t,r){var a=[];for(let e=0;e<t.children.length;e++){var n=t.children[e],i=r[n.ID],o={name:i.attrName,initialWeight:i.DeformPercent,id:i.id,fullWeights:i.FullWeights.a};if("BlendShapeChannel"!==i.attrType)return;o.geoID=connections.get(parseInt(n.ID)).children.filter(function(e){return void 0===e.relationship})[0].ID,a.push(o)}return a}parseScene(e,t,r){sceneGraph=new Group;const a=this.parseModels(e.skeletons,t,r),n=fbxTree.Objects.Model,i=this;a.forEach(function(t){var e=n[t.ID];i.setLookAtProperties(t,e),connections.get(t.ID).parents.forEach(function(e){e=a.get(e.ID);void 0!==e&&e.add(t)}),null===t.parent&&sceneGraph.add(t)}),this.bindSkeleton(e.skeletons,t,a),this.createAmbientLight(),sceneGraph.traverse(function(e){var t;e.userData.transformData&&(e.parent&&(e.userData.transformData.parentMatrix=e.parent.matrix,e.userData.transformData.parentMatrixWorld=e.parent.matrixWorld),t=generateTransform(e.userData.transformData),e.applyMatrix4(t),e.updateWorldMatrix())});r=(new AnimationParser).parse();1===sceneGraph.children.length&&sceneGraph.children[0].isGroup&&(sceneGraph.children[0].animations=r,sceneGraph=sceneGraph.children[0]),sceneGraph.animations=r}parseModels(t,r,a){var n=new Map,i=fbxTree.Objects.Model;for(const c in i){var o=parseInt(c),s=i[c],l=connections.get(o);let e=this.buildSkeleton(l,t,o,s.attrName);if(!e){switch(s.attrType){case"Camera":e=this.createCamera(l);break;case"Light":e=this.createLight(l);break;case"Mesh":e=this.createMesh(l,r,a);break;case"NurbsCurve":e=this.createCurve(l,r);break;case"LimbNode":case"Root":e=new Bone;break;default:e=new Group}e.name=s.attrName?PropertyBinding.sanitizeNodeName(s.attrName):"",e.ID=o}this.getTransformData(e,s),n.set(o,e)}return n}buildSkeleton(e,t,i,o){let s=null;return e.parents.forEach(function(a){for(const e in t){const n=t[e];n.rawBones.forEach(function(e,t){var r;e.ID===a.ID&&(r=s,(s=new Bone).matrixWorld.copy(e.transformLink),s.name=o?PropertyBinding.sanitizeNodeName(o):"",s.ID=i,n.bones[t]=s,null!==r&&s.add(r))})}}),s}createCamera(e){let o,s;if(e.children.forEach(function(e){e=fbxTree.Objects.NodeAttribute[e.ID];void 0!==e&&(s=e)}),void 0===s)o=new Object3D;else{let e=0,t=(void 0!==s.CameraProjectionType&&1===s.CameraProjectionType.value&&(e=1),1),r=(void 0!==s.NearPlane&&(t=s.NearPlane.value/1e3),1e3),a=(void 0!==s.FarPlane&&(r=s.FarPlane.value/1e3),window.innerWidth),n=window.innerHeight;void 0!==s.AspectWidth&&void 0!==s.AspectHeight&&(a=s.AspectWidth.value,n=s.AspectHeight.value);var l=a/n;let i=45;void 0!==s.FieldOfView&&(i=s.FieldOfView.value);var c=s.FocalLength?s.FocalLength.value:null;switch(e){case 0:o=new PerspectiveCamera(i,l,t,r),null!==c&&o.setFocalLength(c);break;case 1:o=new OrthographicCamera(-a/2,a/2,n/2,-n/2,t,r);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+e+"."),o=new Object3D}}return o}createLight(e){let o,s;if(e.children.forEach(function(e){e=fbxTree.Objects.NodeAttribute[e.ID];void 0!==e&&(s=e)}),void 0===s)o=new Object3D;else{let r,a=(r=void 0===s.LightType?0:s.LightType.value,16777215),n=(void 0!==s.Color&&(a=(new Color).fromArray(s.Color.value)),void 0===s.Intensity?1:s.Intensity.value/100),i=(void 0!==s.CastLightOnObject&&0===s.CastLightOnObject.value&&(n=0),0);void 0!==s.FarAttenuationEnd&&(i=void 0!==s.EnableFarAttenuation&&0===s.EnableFarAttenuation.value?0:s.FarAttenuationEnd.value);switch(r){case 0:o=new PointLight(a,n,i,1);break;case 1:o=new DirectionalLight(a,n);break;case 2:let e=Math.PI/3,t=(void 0!==s.InnerAngle&&(e=MathUtils.degToRad(s.InnerAngle.value)),0);void 0!==s.OuterAngle&&(t=MathUtils.degToRad(s.OuterAngle.value),t=Math.max(t,1)),o=new SpotLight(a,n,i,e,t,1);break;default:console.warn("THREE.FBXLoader: Unknown light type "+s.LightType.value+", defaulting to a PointLight."),o=new PointLight(a,n)}void 0!==s.CastShadows&&1===s.CastShadows.value&&(o.castShadow=!0)}return o}createMesh(e,t,r){let a,n=null,i=null;const o=[];return e.children.forEach(function(e){t.has(e.ID)&&(n=t.get(e.ID)),r.has(e.ID)&&o.push(r.get(e.ID))}),1<o.length?i=o:0<o.length?i=o[0]:(i=new MeshPhongMaterial({color:13421772}),o.push(i)),"color"in n.attributes&&o.forEach(function(e){e.vertexColors=!0}),n.FBX_Deformer?(a=new SkinnedMesh(n,i)).normalizeSkinWeights():a=new Mesh(n,i),a}createCurve(e,r){var e=e.children.reduce(function(e,t){return e=r.has(t.ID)?r.get(t.ID):e},null),t=new LineBasicMaterial({color:3342591,linewidth:1});return new Line(e,t)}getTransformData(e,t){var r={};"InheritType"in t&&(r.inheritType=parseInt(t.InheritType.value)),"RotationOrder"in t?r.eulerOrder=getEulerOrder(t.RotationOrder.value):r.eulerOrder="ZYX","Lcl_Translation"in t&&(r.translation=t.Lcl_Translation.value),"PreRotation"in t&&(r.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(r.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(r.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(r.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(r.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(r.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(r.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(r.rotationPivot=t.RotationPivot.value),e.userData.transformData=r}setLookAtProperties(t,e){"LookAtProperty"in e&&connections.get(t.ID).children.forEach(function(e){"LookAtProperty"===e.relationship&&"Lcl_Translation"in(e=fbxTree.Objects.Model[e.ID])&&(e=e.Lcl_Translation.value,void 0!==t.target?(t.target.position.fromArray(e),sceneGraph.add(t.target)):t.lookAt((new Vector3).fromArray(e)))})}bindSkeleton(e,t,r){const a=this.parsePoseNodes();for(const n in e){const i=e[n];connections.get(parseInt(i.ID)).parents.forEach(function(e){t.has(e.ID)&&(e=e.ID,connections.get(e).parents.forEach(function(e){r.has(e.ID)&&r.get(e.ID).bind(new Skeleton(i.bones),a[e.ID])}))})}}parsePoseNodes(){const t={};if("Pose"in fbxTree.Objects){var e,r=fbxTree.Objects.Pose;for(const a in r)"BindPose"===r[a].attrType&&0<r[a].NbPoseNodes&&(e=r[a].PoseNode,Array.isArray(e)?e.forEach(function(e){t[e.Node]=(new Matrix4).fromArray(e.Matrix.a)}):t[e.Node]=(new Matrix4).fromArray(e.Matrix.a))}return t}createAmbientLight(){var e,t,r;"GlobalSettings"in fbxTree&&"AmbientColor"in fbxTree.GlobalSettings&&(r=(t=fbxTree.GlobalSettings.AmbientColor.value)[0],e=t[1],t=t[2],0===r&&0===e&&0===t||(r=new Color(r,e,t),sceneGraph.add(new AmbientLight(r,1))))}}class GeometryParser{constructor(){this.negativeMaterialIndices=!1}parse(e){var t=new Map;if("Geometry"in fbxTree.Objects){var r=fbxTree.Objects.Geometry;for(const n in r){var a=connections.get(parseInt(n)),a=this.parseGeometry(a,r[n],e);t.set(parseInt(n),a)}}return!0===this.negativeMaterialIndices&&console.warn("THREE.FBXLoader: The FBX file contains invalid (negative) material indices. The asset might not render as expected."),t}parseGeometry(e,t,r){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,r);case"NurbsCurve":return this.parseNurbsGeometry(t)}}parseMeshGeometry(e,t,r){const a=r.skeletons,n=[];var i,o=e.parents.map(function(e){return fbxTree.Objects.Model[e.ID]});if(0!==o.length)return i=e.children.reduce(function(e,t){return e=void 0!==a[t.ID]?a[t.ID]:e},null),e.children.forEach(function(e){void 0!==r.morphTargets[e.ID]&&n.push(r.morphTargets[e.ID])}),e={},"RotationOrder"in(o=o[0])&&(e.eulerOrder=getEulerOrder(o.RotationOrder.value)),"InheritType"in o&&(e.inheritType=parseInt(o.InheritType.value)),"GeometricTranslation"in o&&(e.translation=o.GeometricTranslation.value),"GeometricRotation"in o&&(e.rotation=o.GeometricRotation.value),"GeometricScaling"in o&&(e.scale=o.GeometricScaling.value),o=generateTransform(e),this.genGeometry(t,i,n,o)}genGeometry(e,t,r,a){const n=new BufferGeometry;e.attrName&&(n.name=e.attrName);var i=this.parseGeoNode(e,t);const o=this.genBuffers(i);var s=new Float32BufferAttribute(o.vertex,3);if(s.applyMatrix4(a),n.setAttribute("position",s),0<o.colors.length&&n.setAttribute("color",new Float32BufferAttribute(o.colors,3)),t&&(n.setAttribute("skinIndex",new Uint16BufferAttribute(o.weightsIndices,4)),n.setAttribute("skinWeight",new Float32BufferAttribute(o.vertexWeights,4)),n.FBX_Deformer=t),0<o.normal.length&&(s=(new Matrix3).getNormalMatrix(a),(t=new Float32BufferAttribute(o.normal,3)).applyNormalMatrix(s),n.setAttribute("normal",t)),o.uvs.forEach(function(e,t){let r="uv"+(t+1).toString();0===t&&(r="uv"),n.setAttribute(r,new Float32BufferAttribute(o.uvs[t],2))}),i.material&&"AllSame"!==i.material.mappingType){let r=o.materialIndex[0],a=0;o.materialIndex.forEach(function(e,t){e!==r&&(n.addGroup(a,t-a,r),r=e,a=t)}),0<n.groups.length&&((t=(s=n.groups[n.groups.length-1]).start+s.count)!==o.materialIndex.length&&n.addGroup(t,o.materialIndex.length-t,r)),0===n.groups.length&&n.addGroup(0,o.materialIndex.length,o.materialIndex[0])}return this.addMorphTargets(n,e,r,a),n}parseGeoNode(t,e){const n={};if(n.vertexPositions=void 0!==t.Vertices?t.Vertices.a:[],n.vertexIndices=void 0!==t.PolygonVertexIndex?t.PolygonVertexIndex.a:[],t.LayerElementColor&&(n.color=this.parseVertexColors(t.LayerElementColor[0])),t.LayerElementMaterial&&(n.material=this.parseMaterialIndices(t.LayerElementMaterial[0])),t.LayerElementNormal&&(n.normal=this.parseNormals(t.LayerElementNormal[0])),t.LayerElementUV){n.uv=[];let e=0;for(;t.LayerElementUV[e];)t.LayerElementUV[e].UV&&n.uv.push(this.parseUVs(t.LayerElementUV[e])),e++}return n.weightTable={},null!==e&&(n.skeleton=e).rawBones.forEach(function(r,a){r.indices.forEach(function(e,t){void 0===n.weightTable[e]&&(n.weightTable[e]=[]),n.weightTable[e].push({id:a,weight:r.weights[t]})})}),n}genBuffers(c){const u={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]};let p=0,h=0,d=!1,f=[],m=[],g=[],v=[],y=[],x=[];const T=this;return c.vertexIndices.forEach(function(r,a){let e,t=!1,i=(r<0&&(r^=-1,t=!0),[]),n=[];var o;if(f.push(3*r,3*r+1,3*r+2),c.color&&(o=getData(a,p,r,c.color),g.push(o[0],o[1],o[2])),c.skeleton){if(void 0!==c.weightTable[r]&&c.weightTable[r].forEach(function(e){n.push(e.weight),i.push(e.id)}),4<n.length){d||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),d=!0);const s=[0,0,0,0],l=[0,0,0,0];n.forEach(function(e,t){let a=e,n=i[t];l.forEach(function(e,t,r){a>e&&(r[t]=a,a=e,r=s[t],s[t]=n,n=r)})}),i=s,n=l}for(;n.length<4;)n.push(0),i.push(0);for(let e=0;e<4;++e)y.push(n[e]),x.push(i[e])}c.normal&&(o=getData(a,p,r,c.normal),m.push(o[0],o[1],o[2])),c.material&&"AllSame"!==c.material.mappingType&&(e=getData(a,p,r,c.material)[0])<0&&(T.negativeMaterialIndices=!0,e=0),c.uv&&c.uv.forEach(function(e,t){e=getData(a,p,r,e);void 0===v[t]&&(v[t]=[]),v[t].push(e[0]),v[t].push(e[1])}),h++,t&&(4<h&&console.warn("THREE.FBXLoader: Polygons with more than four sides are not supported. Make sure to triangulate the geometry during export."),T.genFace(u,c,f,e,m,g,v,y,x,h),p++,h=0,f=[],m=[],g=[],v=[],y=[],x=[])}),u}genFace(a,e,t,n,i,o,s,l,c,u){for(let r=2;r<u;r++)a.vertex.push(e.vertexPositions[t[0]]),a.vertex.push(e.vertexPositions[t[1]]),a.vertex.push(e.vertexPositions[t[2]]),a.vertex.push(e.vertexPositions[t[3*(r-1)]]),a.vertex.push(e.vertexPositions[t[3*(r-1)+1]]),a.vertex.push(e.vertexPositions[t[3*(r-1)+2]]),a.vertex.push(e.vertexPositions[t[3*r]]),a.vertex.push(e.vertexPositions[t[3*r+1]]),a.vertex.push(e.vertexPositions[t[3*r+2]]),e.skeleton&&(a.vertexWeights.push(l[0]),a.vertexWeights.push(l[1]),a.vertexWeights.push(l[2]),a.vertexWeights.push(l[3]),a.vertexWeights.push(l[4*(r-1)]),a.vertexWeights.push(l[4*(r-1)+1]),a.vertexWeights.push(l[4*(r-1)+2]),a.vertexWeights.push(l[4*(r-1)+3]),a.vertexWeights.push(l[4*r]),a.vertexWeights.push(l[4*r+1]),a.vertexWeights.push(l[4*r+2]),a.vertexWeights.push(l[4*r+3]),a.weightsIndices.push(c[0]),a.weightsIndices.push(c[1]),a.weightsIndices.push(c[2]),a.weightsIndices.push(c[3]),a.weightsIndices.push(c[4*(r-1)]),a.weightsIndices.push(c[4*(r-1)+1]),a.weightsIndices.push(c[4*(r-1)+2]),a.weightsIndices.push(c[4*(r-1)+3]),a.weightsIndices.push(c[4*r]),a.weightsIndices.push(c[4*r+1]),a.weightsIndices.push(c[4*r+2]),a.weightsIndices.push(c[4*r+3])),e.color&&(a.colors.push(o[0]),a.colors.push(o[1]),a.colors.push(o[2]),a.colors.push(o[3*(r-1)]),a.colors.push(o[3*(r-1)+1]),a.colors.push(o[3*(r-1)+2]),a.colors.push(o[3*r]),a.colors.push(o[3*r+1]),a.colors.push(o[3*r+2])),e.material&&"AllSame"!==e.material.mappingType&&(a.materialIndex.push(n),a.materialIndex.push(n),a.materialIndex.push(n)),e.normal&&(a.normal.push(i[0]),a.normal.push(i[1]),a.normal.push(i[2]),a.normal.push(i[3*(r-1)]),a.normal.push(i[3*(r-1)+1]),a.normal.push(i[3*(r-1)+2]),a.normal.push(i[3*r]),a.normal.push(i[3*r+1]),a.normal.push(i[3*r+2])),e.uv&&e.uv.forEach(function(e,t){void 0===a.uvs[t]&&(a.uvs[t]=[]),a.uvs[t].push(s[t][0]),a.uvs[t].push(s[t][1]),a.uvs[t].push(s[t][2*(r-1)]),a.uvs[t].push(s[t][2*(r-1)+1]),a.uvs[t].push(s[t][2*r]),a.uvs[t].push(s[t][2*r+1])})}addMorphTargets(r,a,e,n){if(0!==e.length){r.morphTargetsRelative=!0,r.morphAttributes.position=[];const i=this;e.forEach(function(e){e.rawTargets.forEach(function(e){var t=fbxTree.Objects.Geometry[e.geoID];void 0!==t&&i.genMorphGeometry(r,a,t,n,e.name)})})}}genMorphGeometry(e,t,r,a,n){var t=void 0!==t.PolygonVertexIndex?t.PolygonVertexIndex.a:[],i=void 0!==r.Vertices?r.Vertices.a:[],o=void 0!==r.Indexes?r.Indexes.a:[],s=3*e.attributes.position.count,l=new Float32Array(s);for(let e=0;e<o.length;e++){var c=3*o[e];l[c]=i[3*e],l[1+c]=i[3*e+1],l[2+c]=i[3*e+2]}s=this.genBuffers({vertexIndices:t,vertexPositions:l}),t=new Float32BufferAttribute(s.vertex,3);t.name=n||r.attrName,t.applyMatrix4(a),e.morphAttributes.position.push(t)}parseNormals(e){var t=e.MappingInformationType,r=e.ReferenceInformationType,a=e.Normals.a;let n=[];return"IndexToDirect"===r&&("NormalIndex"in e?n=e.NormalIndex.a:"NormalsIndex"in e&&(n=e.NormalsIndex.a)),{dataSize:3,buffer:a,indices:n,mappingType:t,referenceType:r}}parseUVs(e){var t=e.MappingInformationType,r=e.ReferenceInformationType;let a=[];return{dataSize:2,buffer:e.UV.a,indices:a="IndexToDirect"===r?e.UVIndex.a:a,mappingType:t,referenceType:r}}parseVertexColors(e){var t=e.MappingInformationType,r=e.ReferenceInformationType;let a=[];return{dataSize:4,buffer:e.Colors.a,indices:a="IndexToDirect"===r?e.ColorIndex.a:a,mappingType:t,referenceType:r}}parseMaterialIndices(e){var t=e.MappingInformationType,r=e.ReferenceInformationType;if("NoMappingInformation"===t)return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:r};var a=e.Materials.a,n=[];for(let e=0;e<a.length;++e)n.push(e);return{dataSize:1,buffer:a,indices:n,mappingType:t,referenceType:r}}parseNurbsGeometry(e){var t=parseInt(e.Order);if(isNaN(t))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new BufferGeometry;var r=t-1,t=e.KnotVector.a,a=[],n=e.Points.a;for(let e=0,t=n.length;e<t;e+=4)a.push((new Vector4).fromArray(n,e));let i,o;if("Closed"===e.Form)a.push(a[0]);else if("Periodic"===e.Form){i=r,o=t.length-1-i;for(let e=0;e<r;++e)a.push(a[e])}e=new NURBSCurve(r,t,a,i,o).getPoints(12*a.length);return(new BufferGeometry).setFromPoints(e)}}class AnimationParser{parse(){var e=[],t=this.parseClips();if(void 0!==t)for(const a in t){var r=t[a],r=this.addClip(r);e.push(r)}return e}parseClips(){var e;if(void 0!==fbxTree.Objects.AnimationCurve)return e=this.parseAnimationCurveNodes(),this.parseAnimationCurves(e),e=this.parseAnimationLayers(e),this.parseAnimStacks(e)}parseAnimationCurveNodes(){var e=fbxTree.Objects.AnimationCurveNode,t=new Map;for(const a in e){var r=e[a];null!==r.attrName.match(/S|R|T|DeformPercent/)&&(r={id:r.id,attr:r.attrName,curves:{}},t.set(r.id,r))}return t}parseAnimationCurves(e){var t=fbxTree.Objects.AnimationCurve;for(const i in t){var r,a={id:t[i].id,times:t[i].KeyTime.a.map(convertFBXTimeToSeconds),values:t[i].KeyValueFloat.a},n=connections.get(a.id);void 0!==n&&(r=n.parents[0].ID,(n=n.parents[0].relationship).match(/X/)?e.get(r).curves.x=a:n.match(/Y/)?e.get(r).curves.y=a:n.match(/Z/)?e.get(r).curves.z=a:n.match(/d|DeformPercent/)&&e.has(r)&&(e.get(r).curves.morph=a))}}parseAnimationLayers(o){var e=fbxTree.Objects.AnimationLayer,t=new Map;for(const a in e){const s=[];var r=connections.get(parseInt(a));void 0!==r&&(r.children.forEach(function(e,t){if(o.has(e.ID)){var r=o.get(e.ID);if(void 0!==r.curves.x||void 0!==r.curves.y||void 0!==r.curves.z){if(void 0===s[t]){var a=connections.get(e.ID).parents.filter(function(e){return void 0!==e.relationship})[0].ID;if(void 0!==a){const n=fbxTree.Objects.Model[a.toString()];if(void 0===n)return void console.warn("THREE.FBXLoader: Encountered a unused curve.",e);const i={modelName:n.attrName?PropertyBinding.sanitizeNodeName(n.attrName):"",ID:n.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};sceneGraph.traverse(function(e){e.ID===n.id&&(i.transform=e.matrix,e.userData.transformData&&(i.eulerOrder=e.userData.transformData.eulerOrder))}),i.transform||(i.transform=new Matrix4),"PreRotation"in n&&(i.preRotation=n.PreRotation.value),"PostRotation"in n&&(i.postRotation=n.PostRotation.value),s[t]=i}}s[t]&&(s[t][r.attr]=r)}else void 0!==r.curves.morph&&(void 0===s[t]&&(a=connections.get(e.ID).parents.filter(function(e){return void 0!==e.relationship})[0].ID,e=connections.get(a).parents[0].ID,e=connections.get(e).parents[0].ID,e=connections.get(e).parents[0].ID,e={modelName:(e=fbxTree.Objects.Model[e]).attrName?PropertyBinding.sanitizeNodeName(e.attrName):"",morphName:fbxTree.Objects.Deformer[a].attrName},s[t]=e),s[t][r.attr]=r)}}),t.set(parseInt(a),s))}return t}parseAnimStacks(e){var t=fbxTree.Objects.AnimationStack,r={};for(const n in t){var a=connections.get(parseInt(n)).children,a=(1<a.length&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers."),e.get(a[0].ID));r[n]={name:t[n].attrName,layer:a}}return r}addClip(e){let t=[];const r=this;return e.layer.forEach(function(e){t=t.concat(r.generateTracks(e))}),new AnimationClip(e.name,-1,t)}generateTracks(e){var t=[];let r=new Vector3;var a,n=new Quaternion;let i=new Vector3;return e.transform&&e.transform.decompose(r,n,i),r=r.toArray(),n=(new Euler).setFromQuaternion(n,e.eulerOrder).toArray(),i=i.toArray(),void 0!==e.T&&0<Object.keys(e.T.curves).length&&(void 0!==(a=this.generateVectorTrack(e.modelName,e.T.curves,r,"position"))&&t.push(a)),void 0!==e.R&&0<Object.keys(e.R.curves).length&&(void 0!==(a=this.generateRotationTrack(e.modelName,e.R.curves,n,e.preRotation,e.postRotation,e.eulerOrder))&&t.push(a)),void 0!==e.S&&0<Object.keys(e.S.curves).length&&(void 0!==(n=this.generateVectorTrack(e.modelName,e.S.curves,i,"scale"))&&t.push(n)),void 0!==e.DeformPercent&&void 0!==(a=this.generateMorphTrack(e))&&t.push(a),t}generateVectorTrack(e,t,r,a){var n=this.getTimesForAllAxes(t),t=this.getKeyframeTrackValues(n,t,r);return new VectorKeyframeTrack(e+"."+a,n,t)}generateRotationTrack(e,t,r,a,n,i){void 0!==t.x&&(this.interpolateRotations(t.x),t.x.values=t.x.values.map(MathUtils.degToRad)),void 0!==t.y&&(this.interpolateRotations(t.y),t.y.values=t.y.values.map(MathUtils.degToRad)),void 0!==t.z&&(this.interpolateRotations(t.z),t.z.values=t.z.values.map(MathUtils.degToRad));var o=this.getTimesForAllAxes(t),s=this.getKeyframeTrackValues(o,t,r),l=(void 0!==a&&((a=a.map(MathUtils.degToRad)).push(i),a=(new Euler).fromArray(a),a=(new Quaternion).setFromEuler(a)),void 0!==n&&((n=n.map(MathUtils.degToRad)).push(i),n=(new Euler).fromArray(n),n=(new Quaternion).setFromEuler(n).invert()),new Quaternion),c=new Euler,u=[];for(let e=0;e<s.length;e+=3)c.set(s[e],s[e+1],s[e+2],i),l.setFromEuler(c),void 0!==a&&l.premultiply(a),void 0!==n&&l.multiply(n),l.toArray(u,e/3*4);return new QuaternionKeyframeTrack(e+".quaternion",o,u)}generateMorphTrack(e){var t=e.DeformPercent.curves.morph,r=t.values.map(function(e){return e/100}),a=sceneGraph.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new NumberKeyframeTrack(e.modelName+".morphTargetInfluences["+a+"]",t.times,r)}getTimesForAllAxes(e){let a=[];if(void 0!==e.x&&(a=a.concat(e.x.times)),void 0!==e.y&&(a=a.concat(e.y.times)),1<(a=(a=void 0!==e.z?a.concat(e.z.times):a).sort(function(e,t){return e-t})).length){let t=1,r=a[0];for(let e=1;e<a.length;e++){var n=a[e];n!==r&&(a[t]=n,r=n,t++)}a=a.slice(0,t)}return a}getKeyframeTrackValues(e,t,r){const a=r,n=[];let i=-1,o=-1,s=-1;return e.forEach(function(e){t.x&&(i=t.x.times.indexOf(e)),t.y&&(o=t.y.times.indexOf(e)),t.z&&(s=t.z.times.indexOf(e)),-1!==i?(e=t.x.values[i],n.push(e),a[0]=e):n.push(a[0]),-1!==o?(e=t.y.values[o],n.push(e),a[1]=e):n.push(a[1]),-1!==s?(e=t.z.values[s],n.push(e),a[2]=e):n.push(a[2])}),n}interpolateRotations(a){for(let r=1;r<a.values.length;r++){var n=a.values[r-1],i=a.values[r]-n,o=Math.abs(i);if(180<=o){var o=o/180,s=i/o;let e=n+s;var i=a.times[r-1],l=(a.times[r]-i)/o;let t=i+l;for(var c=[],u=[];t<a.times[r];)c.push(t),t+=l,u.push(e),e+=s;a.times=inject(a.times,r,c),a.values=inject(a.values,r,u)}}}}class TextParser{getPrevNode(){return this.nodeStack[this.currentIndent-2]}getCurrentNode(){return this.nodeStack[this.currentIndent-1]}getCurrentProp(){return this.currentProp}pushStack(e){this.nodeStack.push(e),this.currentIndent+=1}popStack(){this.nodeStack.pop(),--this.currentIndent}setCurrentProp(e,t){this.currentProp=e,this.currentPropName=t}parse(e){this.currentIndent=0,this.allNodes=new FBXTree,this.nodeStack=[],this.currentProp=[],this.currentPropName="";const i=this,o=e.split(/[\r\n]+/);return o.forEach(function(e,t){var r,a=e.match(/^[\s\t]*;/),n=e.match(/^[\s\t]*$/);a||n||(a=e.match("^\\t{"+i.currentIndent+"}(\\w+):(.*){",""),n=e.match("^\\t{"+i.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),r=e.match("^\\t{"+(i.currentIndent-1)+"}}"),a?i.parseNodeBegin(e,a):n?i.parseNodeProperty(e,n,o[++t]):r?i.popStack():e.match(/^[^\s\t}]/)&&i.parseNodePropertyContinued(e))}),this.allNodes}parseNodeBegin(e,t){var r=t[1].trim().replace(/^"/,"").replace(/"$/,""),t=t[2].split(",").map(function(e){return e.trim().replace(/^"/,"").replace(/"$/,"")}),a={name:r},t=this.parseNodeAttr(t),n=this.getCurrentNode();0===this.currentIndent?this.allNodes.add(r,a):r in n?("PoseNode"===r?n.PoseNode.push(a):void 0!==n[r].id&&(n[r]={},n[r][n[r].id]=n[r]),""!==t.id&&(n[r][t.id]=a)):"number"==typeof t.id?(n[r]={},n[r][t.id]=a):"Properties70"!==r&&(n[r]="PoseNode"===r?[a]:a),"number"==typeof t.id&&(a.id=t.id),""!==t.name&&(a.attrName=t.name),""!==t.type&&(a.attrType=t.type),this.pushStack(a)}parseNodeAttr(e){let t=e[0],r=(""!==e[0]&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0])),""),a="";return 1<e.length&&(r=e[1].replace(/^(\w+)::/,""),a=e[2]),{id:t,name:r,type:a}}parseNodeProperty(t,r,a){let n=r[1].replace(/^"/,"").replace(/"$/,"").trim(),i=r[2].replace(/^"/,"").replace(/"$/,"").trim();"Content"===n&&","===i&&(i=a.replace(/"/g,"").replace(/,$/,"").trim());r=this.getCurrentNode();if("Properties70"===r.name)this.parseNodeSpecialProperty(t,n,i);else{if("C"===n){a=i.split(",").slice(1),t=parseInt(a[0]),a=parseInt(a[1]);let e=i.split(",").slice(3);e=e.map(function(e){return e.trim().replace(/^"/,"")}),n="connections",append(i=[t,a],e),void 0===r[n]&&(r[n]=[])}"Node"===n&&(r.id=i),n in r&&Array.isArray(r[n])?r[n].push(i):"a"!==n?r[n]=i:r.a=i,this.setCurrentProp(r,n),"a"===n&&","!==i.slice(-1)&&(r.a=parseNumberArray(i))}}parseNodePropertyContinued(e){var t=this.getCurrentNode();t.a+=e,","!==e.slice(-1)&&(t.a=parseNumberArray(t.a))}parseNodeSpecialProperty(e,t,r){var r=r.split('",').map(function(e){return e.trim().replace(/^\"/,"").replace(/\s/,"_")}),a=r[0],n=r[1],i=r[2],o=r[3];let s=r[4];switch(n){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":s=parseFloat(s);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":s=parseNumberArray(s)}this.getPrevNode()[a]={type:n,type2:i,flag:o,value:s},this.setCurrentProp(this.getPrevNode(),a)}}class BinaryParser{parse(e){var t=new BinaryReader(e),r=(t.skip(23),t.getUint32());if(r<6400)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+r);for(var a=new FBXTree;!this.endOfContent(t);){var n=this.parseNode(t,r);null!==n&&a.add(n.name,n)}return a}endOfContent(e){return e.size()%16==0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()}parseNode(t,e){var r={},a=7500<=e?t.getUint64():t.getUint32(),n=7500<=e?t.getUint64():t.getUint32(),i=(7500<=e?t.getUint64():t.getUint32(),t.getUint8()),o=t.getString(i);if(0===a)return null;var s=[];for(let e=0;e<n;e++)s.push(this.parseProperty(t));var i=0<s.length?s[0]:"",l=1<s.length?s[1]:"",c=2<s.length?s[2]:"";for(r.singleProperty=1===n&&t.getOffset()===a;a>t.getOffset();){var u=this.parseNode(t,e);null!==u&&this.parseSubNode(o,r,u)}return r.propertyList=s,"number"==typeof i&&(r.id=i),""!==l&&(r.attrName=l),""!==c&&(r.attrType=c),""!==o&&(r.name=o),r}parseSubNode(a,n,i){if(!0===i.singleProperty){var o=i.propertyList[0];Array.isArray(o)?(n[i.name]=i).a=o:n[i.name]=o}else if("Connections"===a&&"C"===i.name){const r=[];i.propertyList.forEach(function(e,t){0!==t&&r.push(e)}),void 0===n.connections&&(n.connections=[]),n.connections.push(r)}else if("Properties70"===i.name)Object.keys(i).forEach(function(e){n[e]=i[e]});else if("Properties70"===a&&"P"===i.name){let e=i.propertyList[0],t=i.propertyList[1];o=i.propertyList[2],a=i.propertyList[3];let r;0===e.indexOf("Lcl ")&&(e=e.replace("Lcl ","Lcl_")),0===t.indexOf("Lcl ")&&(t=t.replace("Lcl ","Lcl_")),r="Color"===t||"ColorRGB"===t||"Vector"===t||"Vector3D"===t||0===t.indexOf("Lcl_")?[i.propertyList[4],i.propertyList[5],i.propertyList[6]]:i.propertyList[4],n[e]={type:t,type2:o,flag:a,value:r}}else void 0===n[i.name]?"number"==typeof i.id?(n[i.name]={},n[i.name][i.id]=i):n[i.name]=i:"PoseNode"===i.name?(Array.isArray(n[i.name])||(n[i.name]=[n[i.name]]),n[i.name].push(i)):void 0===n[i.name][i.id]&&(n[i.name][i.id]=i)}parseProperty(e){var t=e.getString(1);let r;switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":return r=e.getUint32(),e.getArrayBuffer(r);case"S":return r=e.getUint32(),e.getString(r);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":var a=e.getUint32(),n=e.getUint32(),i=e.getUint32();if(0===n)switch(t){case"b":case"c":return e.getBooleanArray(a);case"d":return e.getFloat64Array(a);case"f":return e.getFloat32Array(a);case"i":return e.getInt32Array(a);case"l":return e.getInt64Array(a)}var n=fflate.unzlibSync(new Uint8Array(e.getArrayBuffer(i))),o=new BinaryReader(n.buffer);switch(t){case"b":case"c":return o.getBooleanArray(a);case"d":return o.getFloat64Array(a);case"f":return o.getFloat32Array(a);case"i":return o.getInt32Array(a);case"l":return o.getInt64Array(a)}break;default:throw new Error("THREE.FBXLoader: Unknown property type "+t)}}}class BinaryReader{constructor(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=void 0===t||t}getOffset(){return this.offset}size(){return this.dv.buffer.byteLength}skip(e){this.offset+=e}getBoolean(){return 1==(1&this.getUint8())}getBooleanArray(t){var r=[];for(let e=0;e<t;e++)r.push(this.getBoolean());return r}getUint8(){var e=this.dv.getUint8(this.offset);return this.offset+=1,e}getInt16(){var e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}getInt32(){var e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}getInt32Array(t){var r=[];for(let e=0;e<t;e++)r.push(this.getInt32());return r}getUint32(){var e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}getInt64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),2147483648&t?(t=4294967295&~t,4294967295===(e=4294967295&~e)&&(t=t+1&4294967295),e=e+1&4294967295,-(4294967296*t+e)):4294967296*t+e}getInt64Array(t){var r=[];for(let e=0;e<t;e++)r.push(this.getInt64());return r}getUint64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),4294967296*t+e}getFloat32(){var e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}getFloat32Array(t){var r=[];for(let e=0;e<t;e++)r.push(this.getFloat32());return r}getFloat64(){var e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}getFloat64Array(t){var r=[];for(let e=0;e<t;e++)r.push(this.getFloat64());return r}getArrayBuffer(e){var t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}getString(t){let r=[];for(let e=0;e<t;e++)r[e]=this.getUint8();var e=r.indexOf(0);return 0<=e&&(r=r.slice(0,e)),LoaderUtils.decodeText(new Uint8Array(r))}}class FBXTree{add(e,t){this[e]=t}}function isFbxFormatBinary(e){var t="Kaydara FBX Binary  \0";return e.byteLength>=t.length&&t===convertArrayBufferToString(e,0,t.length)}function isFbxFormatASCII(t){var r,a,n=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"];let i=0;for(let e=0;e<n.length;++e)if(a=void 0,a=t[(r=1)-1],t=t.slice(i+r),i++,a===n[e])return!1;return!0}function getFbxVersion(e){e=e.match(/FBXVersion: (\d+)/);if(e)return parseInt(e[1]);throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function convertFBXTimeToSeconds(e){return e/46186158e3}const dataArray=[];function getData(e,t,r,a){let n;switch(a.mappingType){case"ByPolygonVertex":n=e;break;case"ByPolygon":n=t;break;case"ByVertice":n=r;break;case"AllSame":n=a.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+a.mappingType)}var i=(n="IndexToDirect"===a.referenceType?a.indices[n]:n)*a.dataSize,o=i+a.dataSize;return slice(dataArray,a.buffer,i,o)}const tempEuler=new Euler,tempVec=new Vector3;function generateTransform(e){var t=new Matrix4,r=new Matrix4,a=new Matrix4,n=new Matrix4,i=new Matrix4,o=new Matrix4,s=new Matrix4,l=new Matrix4,c=new Matrix4,u=new Matrix4,p=new Matrix4,h=new Matrix4,d=e.inheritType||0,f=(e.translation&&t.setPosition(tempVec.fromArray(e.translation)),e.preRotation&&((f=e.preRotation.map(MathUtils.degToRad)).push(e.eulerOrder||Euler.DefaultOrder),r.makeRotationFromEuler(tempEuler.fromArray(f))),e.rotation&&((f=e.rotation.map(MathUtils.degToRad)).push(e.eulerOrder||Euler.DefaultOrder),a.makeRotationFromEuler(tempEuler.fromArray(f))),e.postRotation&&((f=e.postRotation.map(MathUtils.degToRad)).push(e.eulerOrder||Euler.DefaultOrder),n.makeRotationFromEuler(tempEuler.fromArray(f)),n.invert()),e.scale&&i.scale(tempVec.fromArray(e.scale)),e.scalingOffset&&s.setPosition(tempVec.fromArray(e.scalingOffset)),e.scalingPivot&&o.setPosition(tempVec.fromArray(e.scalingPivot)),e.rotationOffset&&l.setPosition(tempVec.fromArray(e.rotationOffset)),e.rotationPivot&&c.setPosition(tempVec.fromArray(e.rotationPivot)),e.parentMatrixWorld&&(p.copy(e.parentMatrix),u.copy(e.parentMatrixWorld)),r.clone().multiply(a).multiply(n)),e=new Matrix4,m=(e.extractRotation(u),new Matrix4),m=(m.copyPosition(u),m.clone().invert().multiply(u)),m=e.clone().invert().multiply(m),g=i,v=new Matrix4,m=((0===d?v.copy(e).multiply(f).multiply(m):1===d?v.copy(e).multiply(m).multiply(f):(d=(new Matrix4).scale((new Vector3).setFromMatrixScale(p)).clone().invert(),p=m.clone().multiply(d),v.copy(e).multiply(f).multiply(p))).multiply(g),c.clone().invert()),d=o.clone().invert(),e=t.clone().multiply(l).multiply(c).multiply(r).multiply(a).multiply(n).multiply(m).multiply(s).multiply(o).multiply(i).multiply(d),f=(new Matrix4).copyPosition(e),p=u.clone().multiply(f);return h.copyPosition(p),(e=h.clone().multiply(v)).premultiply(u.invert()),e}function getEulerOrder(e){var t=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return 6===(e=e||0)?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),t[0]):t[e]}function parseNumberArray(e){return e.split(",").map(function(e){return parseFloat(e)})}function convertArrayBufferToString(e,t,r){return void 0===t&&(t=0),void 0===r&&(r=e.byteLength),LoaderUtils.decodeText(new Uint8Array(e,t,r))}function append(a,n){for(let e=0,t=a.length,r=n.length;e<r;e++,t++)a[t]=n[e]}function slice(r,a,n,i){for(let e=n,t=0;e<i;e++,t++)r[t]=a[e];return r}function inject(e,t,r){return e.slice(0,t).concat(r).concat(e.slice(t))}export{FBXLoader};