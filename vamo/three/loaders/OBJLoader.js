import{BufferGeometry,FileLoader,Float32BufferAttribute,Group,LineBasicMaterial,LineSegments,Loader,Material,Mesh,MeshPhongMaterial,Points,PointsMaterial,Vector3,Color}from"../three.module.js";const _object_pattern=/^[og]\s*(.+)?/,_material_library_pattern=/^mtllib /,_material_use_pattern=/^usemtl /,_map_use_pattern=/^usemap /,_face_vertex_data_separator_pattern=/\s+/,_vA=new Vector3,_vB=new Vector3,_vC=new Vector3,_ab=new Vector3,_cb=new Vector3,_color=new Color;function ParserState(){var e={objects:[],object:{},vertices:[],normals:[],colors:[],uvs:[],materials:{},materialLibraries:[],startObject:function(e,t){var r;this.object&&!1===this.object.fromDeclaration?(this.object.name=e,this.object.fromDeclaration=!1!==t):(r=this.object&&"function"==typeof this.object.currentMaterial?this.object.currentMaterial():void 0,this.object&&"function"==typeof this.object._finalize&&this.object._finalize(!0),this.object={name:e||"",fromDeclaration:!1!==t,geometry:{vertices:[],normals:[],colors:[],uvs:[],hasUVIndices:!1},materials:[],smooth:!0,startMaterial:function(e,t){var r=this._finalize(!1),e=(r&&(r.inherited||r.groupCount<=0)&&this.materials.splice(r.index,1),{index:this.materials.length,name:e||"",mtllib:Array.isArray(t)&&0<t.length?t[t.length-1]:"",smooth:(void 0!==r?r:this).smooth,groupStart:void 0!==r?r.groupEnd:0,groupEnd:-1,groupCount:-1,inherited:!1,clone:function(e){e={index:"number"==typeof e?e:this.index,name:this.name,mtllib:this.mtllib,smooth:this.smooth,groupStart:0,groupEnd:-1,groupCount:-1,inherited:!1};return e.clone=this.clone.bind(e),e}});return this.materials.push(e),e},currentMaterial:function(){if(0<this.materials.length)return this.materials[this.materials.length-1]},_finalize:function(e){var t=this.currentMaterial();if(t&&-1===t.groupEnd&&(t.groupEnd=this.geometry.vertices.length/3,t.groupCount=t.groupEnd-t.groupStart,t.inherited=!1),e&&1<this.materials.length)for(let e=this.materials.length-1;0<=e;e--)this.materials[e].groupCount<=0&&this.materials.splice(e,1);return e&&0===this.materials.length&&this.materials.push({name:"",smooth:this.smooth}),t}},r&&r.name&&"function"==typeof r.clone&&((e=r.clone(0)).inherited=!0,this.object.materials.push(e)),this.objects.push(this.object))},finalize:function(){this.object&&"function"==typeof this.object._finalize&&this.object._finalize(!0)},parseVertexIndex:function(e,t){e=parseInt(e,10);return 3*(0<=e?e-1:e+t/3)},parseNormalIndex:function(e,t){e=parseInt(e,10);return 3*(0<=e?e-1:e+t/3)},parseUVIndex:function(e,t){e=parseInt(e,10);return 2*(0<=e?e-1:e+t/2)},addVertex:function(e,t,r){var s=this.vertices,i=this.object.geometry.vertices;i.push(s[e+0],s[e+1],s[e+2]),i.push(s[t+0],s[t+1],s[t+2]),i.push(s[r+0],s[r+1],s[r+2])},addVertexPoint:function(e){var t=this.vertices;this.object.geometry.vertices.push(t[e+0],t[e+1],t[e+2])},addVertexLine:function(e){var t=this.vertices;this.object.geometry.vertices.push(t[e+0],t[e+1],t[e+2])},addNormal:function(e,t,r){var s=this.normals,i=this.object.geometry.normals;i.push(s[e+0],s[e+1],s[e+2]),i.push(s[t+0],s[t+1],s[t+2]),i.push(s[r+0],s[r+1],s[r+2])},addFaceNormal:function(e,t,r){var s=this.vertices,i=this.object.geometry.normals;_vA.fromArray(s,e),_vB.fromArray(s,t),_vC.fromArray(s,r),_cb.subVectors(_vC,_vB),_ab.subVectors(_vA,_vB),_cb.cross(_ab),_cb.normalize(),i.push(_cb.x,_cb.y,_cb.z),i.push(_cb.x,_cb.y,_cb.z),i.push(_cb.x,_cb.y,_cb.z)},addColor:function(e,t,r){var s=this.colors,i=this.object.geometry.colors;void 0!==s[e]&&i.push(s[e+0],s[e+1],s[e+2]),void 0!==s[t]&&i.push(s[t+0],s[t+1],s[t+2]),void 0!==s[r]&&i.push(s[r+0],s[r+1],s[r+2])},addUV:function(e,t,r){var s=this.uvs,i=this.object.geometry.uvs;i.push(s[e+0],s[e+1]),i.push(s[t+0],s[t+1]),i.push(s[r+0],s[r+1])},addDefaultUV:function(){var e=this.object.geometry.uvs;e.push(0,0),e.push(0,0),e.push(0,0)},addUVLine:function(e){var t=this.uvs;this.object.geometry.uvs.push(t[e+0],t[e+1])},addFace:function(e,t,r,s,i,a,o,n,l){var h=this.vertices.length;let c=this.parseVertexIndex(e,h),u=this.parseVertexIndex(t,h),p=this.parseVertexIndex(r,h);this.addVertex(c,u,p),this.addColor(c,u,p),void 0!==o&&""!==o?(e=this.normals.length,c=this.parseNormalIndex(o,e),u=this.parseNormalIndex(n,e),p=this.parseNormalIndex(l,e),this.addNormal(c,u,p)):this.addFaceNormal(c,u,p),void 0!==s&&""!==s?(t=this.uvs.length,c=this.parseUVIndex(s,t),u=this.parseUVIndex(i,t),p=this.parseUVIndex(a,t),this.addUV(c,u,p),this.object.geometry.hasUVIndices=!0):this.addDefaultUV()},addPointGeometry:function(r){this.object.geometry.type="Points";var s=this.vertices.length;for(let e=0,t=r.length;e<t;e++){var i=this.parseVertexIndex(r[e],s);this.addVertexPoint(i),this.addColor(i)}},addLineGeometry:function(r,s){this.object.geometry.type="Line";var i=this.vertices.length,a=this.uvs.length;for(let e=0,t=r.length;e<t;e++)this.addVertexLine(this.parseVertexIndex(r[e],i));for(let e=0,t=s.length;e<t;e++)this.addUVLine(this.parseUVIndex(s[e],a))}};return e.startObject("",!1),e}class OBJLoader extends Loader{constructor(e){super(e),this.materials=null}load(t,r,e,s){const i=this;var a=new FileLoader(this.manager);a.setPath(this.path),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(t,function(e){try{r(i.parse(e))}catch(e){s?s(e):console.error(e),i.manager.itemError(t)}},e,s)}setMaterials(e){return this.materials=e,this}parse(e){var s=new ParserState,r=(e=-1!==(e=-1!==e.indexOf("\r\n")?e.replace(/\r\n/g,"\n"):e).indexOf("\\\n")?e.replace(/\\\n/g,""):e).split("\n");let i=[];for(let e=0,t=r.length;e<t;e++){var a=r[e].trimStart();if(0!==a.length){var o,n=a.charAt(0);if("#"!==n)if("v"===n){var l=a.split(_face_vertex_data_separator_pattern);switch(l[0]){case"v":s.vertices.push(parseFloat(l[1]),parseFloat(l[2]),parseFloat(l[3])),7<=l.length?(_color.setRGB(parseFloat(l[4]),parseFloat(l[5]),parseFloat(l[6])).convertSRGBToLinear(),s.colors.push(_color.r,_color.g,_color.b)):s.colors.push(void 0,void 0,void 0);break;case"vn":s.normals.push(parseFloat(l[1]),parseFloat(l[2]),parseFloat(l[3]));break;case"vt":s.uvs.push(parseFloat(l[1]),parseFloat(l[2]))}}else if("f"===n){var h=a.slice(1).trim().split(_face_vertex_data_separator_pattern),c=[];for(let e=0,t=h.length;e<t;e++){var u=h[e];0<u.length&&(u=u.split("/"),c.push(u))}var p=c[0];for(let e=1,t=c.length-1;e<t;e++){var m=c[e],d=c[e+1];s.addFace(p[0],m[0],d[0],p[1],m[1],d[1],p[2],m[2],d[2])}}else if("l"===n){var f=a.substring(1).trim().split(" ");let r=[];var v=[];if(-1===a.indexOf("/"))r=f;else for(let e=0,t=f.length;e<t;e++){var b=f[e].split("/");""!==b[0]&&r.push(b[0]),""!==b[1]&&v.push(b[1])}s.addLineGeometry(r,v)}else"p"===n?(o=a.slice(1).trim().split(" "),s.addPointGeometry(o)):null!==(i=_object_pattern.exec(a))?(o=(" "+i[0].slice(1).trim()).slice(1),s.startObject(o)):_material_use_pattern.test(a)?s.object.startMaterial(a.substring(7).trim(),s.materialLibraries):_material_library_pattern.test(a)?s.materialLibraries.push(a.substring(7).trim()):_map_use_pattern.test(a)?console.warn('THREE.OBJLoader: Rendering identifier "usemap" not supported. Textures must be defined in MTL files.'):"s"===n?(1<(i=a.split(" ")).length?(n=i[1].trim().toLowerCase(),s.object.smooth="0"!==n&&"off"!==n):s.object.smooth=!0,(n=s.object.currentMaterial())&&(n.smooth=s.object.smooth)):"\0"!==a&&console.warn('THREE.OBJLoader: Unexpected line: "'+a+'"')}}s.finalize();var t,g=new Group,e=(g.materialLibraries=[].concat(s.materialLibraries),!(1===s.objects.length&&0===s.objects[0].geometry.vertices.length));if(!0==e)for(let e=0,t=s.objects.length;e<t;e++){var _=s.objects[e],y=_.geometry,x=_.materials,j="Line"===y.type,V="Points"===y.type;let r=!1;if(0!==y.vertices.length){var w=new BufferGeometry,L=(w.setAttribute("position",new Float32BufferAttribute(y.vertices,3)),0<y.normals.length&&w.setAttribute("normal",new Float32BufferAttribute(y.normals,3)),0<y.colors.length&&(r=!0,w.setAttribute("color",new Float32BufferAttribute(y.colors,3))),!0===y.hasUVIndices&&w.setAttribute("uv",new Float32BufferAttribute(y.uvs,2)),[]);for(let t=0,e=x.length;t<e;t++){var M,A=x[t],B=A.name+"_"+A.smooth+"_"+r;let e=s.materials[B];null!==this.materials&&(e=this.materials.create(A.name),!j||!e||e instanceof LineBasicMaterial?!V||!e||e instanceof PointsMaterial||(M=new PointsMaterial({size:10,sizeAttenuation:!1}),Material.prototype.copy.call(M,e),M.color.copy(e.color),M.map=e.map,e=M):(M=new LineBasicMaterial,Material.prototype.copy.call(M,e),M.color.copy(e.color),e=M)),void 0===e&&((e=j?new LineBasicMaterial:V?new PointsMaterial({size:1,sizeAttenuation:!1}):new MeshPhongMaterial).name=A.name,e.flatShading=!A.smooth,e.vertexColors=r,s.materials[B]=e),L.push(e)}let e;if(1<L.length){for(let e=0,t=x.length;e<t;e++){var F=x[e];w.addGroup(F.groupStart,F.groupCount,e)}e=new(j?LineSegments:V?Points:Mesh)(w,L)}else e=new(j?LineSegments:V?Points:Mesh)(w,L[0]);e.name=_.name,g.add(e)}}else 0<s.vertices.length&&(e=new PointsMaterial({size:1,sizeAttenuation:!1}),(t=new BufferGeometry).setAttribute("position",new Float32BufferAttribute(s.vertices,3)),0<s.colors.length&&void 0!==s.colors[0]&&(t.setAttribute("color",new Float32BufferAttribute(s.colors,3)),e.vertexColors=!0),t=new Points(t,e),g.add(t));return g}}export{OBJLoader};