import{GridHelper,EllipseCurve,BufferGeometry,Line,LineBasicMaterial,Raycaster,Group,Box3,Sphere,Quaternion,Vector2,Vector3,Matrix4,MathUtils,EventDispatcher}from"../three.module.js";const STATE={IDLE:Symbol(),ROTATE:Symbol(),PAN:Symbol(),SCALE:Symbol(),FOV:Symbol(),FOCUS:Symbol(),ZROTATE:Symbol(),TOUCH_MULTI:Symbol(),ANIMATION_FOCUS:Symbol(),ANIMATION_ROTATE:Symbol()},INPUT={NONE:Symbol(),ONE_FINGER:Symbol(),ONE_FINGER_SWITCHED:Symbol(),TWO_FINGER:Symbol(),MULT_FINGER:Symbol(),CURSOR:Symbol()},_center={x:0,y:0},_transformation={camera:new Matrix4,gizmos:new Matrix4},_changeEvent={type:"change"},_startEvent={type:"start"},_endEvent={type:"end"},_raycaster=new Raycaster,_offset=new Vector3,_gizmoMatrixStateTemp=new Matrix4,_cameraMatrixStateTemp=new Matrix4,_scalePointTemp=new Vector3;class ArcballControls extends EventDispatcher{constructor(t,i,s=null){super(),this.camera=null,this.domElement=i,this.scene=s,this.target=new Vector3,this._currentTarget=new Vector3,this.radiusFactor=.67,this.mouseActions=[],this._mouseOp=null,this._v2_1=new Vector2,this._v3_1=new Vector3,this._v3_2=new Vector3,this._m4_1=new Matrix4,this._m4_2=new Matrix4,this._quat=new Quaternion,this._translationMatrix=new Matrix4,this._rotationMatrix=new Matrix4,this._scaleMatrix=new Matrix4,this._rotationAxis=new Vector3,this._cameraMatrixState=new Matrix4,this._cameraProjectionState=new Matrix4,this._fovState=1,this._upState=new Vector3,this._zoomState=1,this._nearPos=0,this._farPos=0,this._gizmoMatrixState=new Matrix4,this._up0=new Vector3,this._zoom0=1,this._fov0=0,this._initialNear=0,this._nearPos0=0,this._initialFar=0,this._farPos0=0,this._cameraMatrixState0=new Matrix4,this._gizmoMatrixState0=new Matrix4,this._button=-1,this._touchStart=[],this._touchCurrent=[],this._input=INPUT.NONE,this._switchSensibility=32,this._startFingerDistance=0,this._currentFingerDistance=0,this._startFingerRotation=0,this._currentFingerRotation=0,this._devPxRatio=0,this._downValid=!0,this._nclicks=0,this._downEvents=[],this._downStart=0,this._clickStart=0,this._maxDownTime=250,this._maxInterval=300,this._posThreshold=24,this._movementThreshold=24,this._currentCursorPosition=new Vector3,this._startCursorPosition=new Vector3,this._grid=null,this._gridPosition=new Vector3,this._gizmos=new Group,this._curvePts=128,this._timeStart=-1,this._animationId=-1,this.focusAnimationTime=500,this._timePrev=0,this._timeCurrent=0,this._anglePrev=0,this._angleCurrent=0,this._cursorPosPrev=new Vector3,this._cursorPosCurr=new Vector3,this._wPrev=0,this._wCurr=0,this.adjustNearFar=!1,this.scaleFactor=1.1,this.dampingFactor=25,this.wMax=20,this.enableAnimations=!0,this.enableGrid=!1,this.cursorZoom=!1,this.minFov=5,this.maxFov=90,this.enabled=!0,this.enablePan=!0,this.enableRotate=!0,this.enableZoom=!0,this.enableGizmos=!0,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this._tbRadius=1,this._state=STATE.IDLE,this.setCamera(t),null!=this.scene&&this.scene.add(this._gizmos),this.domElement.style.touchAction="none",this._devPxRatio=window.devicePixelRatio,this.initializeMouseActions(),this.domElement.addEventListener("contextmenu",this.onContextMenu),this.domElement.addEventListener("wheel",this.onWheel),this.domElement.addEventListener("pointerdown",this.onPointerDown),this.domElement.addEventListener("pointercancel",this.onPointerCancel),window.addEventListener("resize",this.onWindowResize)}onWindowResize=()=>{var t=(this._gizmos.scale.x+this._gizmos.scale.y+this._gizmos.scale.z)/3,t=(this._tbRadius=this.calculateTbRadius(this.camera),this._tbRadius/t),t=new EllipseCurve(0,0,t,t).getPoints(this._curvePts),i=(new BufferGeometry).setFromPoints(t);for(const s in this._gizmos.children)this._gizmos.children[s].geometry=i;this.dispatchEvent(_changeEvent)};onContextMenu=i=>{if(this.enabled)for(let t=0;t<this.mouseActions.length;t++)if(2==this.mouseActions[t].mouse){i.preventDefault();break}};onPointerCancel=()=>{this._touchStart.splice(0,this._touchStart.length),this._touchCurrent.splice(0,this._touchCurrent.length),this._input=INPUT.NONE};onPointerDown=i=>{if(0==i.button&&i.isPrimary?(this._downValid=!0,this._downEvents.push(i),this._downStart=performance.now()):this._downValid=!1,"touch"==i.pointerType&&this._input!=INPUT.CURSOR)switch(this._touchStart.push(i),this._touchCurrent.push(i),this._input){case INPUT.NONE:this._input=INPUT.ONE_FINGER,this.onSinglePanStart(i,"ROTATE"),window.addEventListener("pointermove",this.onPointerMove),window.addEventListener("pointerup",this.onPointerUp);break;case INPUT.ONE_FINGER:case INPUT.ONE_FINGER_SWITCHED:this._input=INPUT.TWO_FINGER,this.onRotateStart(),this.onPinchStart(),this.onDoublePanStart();break;case INPUT.TWO_FINGER:this._input=INPUT.MULT_FINGER,this.onTriplePanStart(i)}else if("touch"!=i.pointerType&&this._input==INPUT.NONE){let t=null;i.ctrlKey||i.metaKey?t="CTRL":i.shiftKey&&(t="SHIFT"),this._mouseOp=this.getOpFromAction(i.button,t),null!=this._mouseOp&&(window.addEventListener("pointermove",this.onPointerMove),window.addEventListener("pointerup",this.onPointerUp),this._input=INPUT.CURSOR,this._button=i.button,this.onSinglePanStart(i,this._mouseOp))}};onPointerMove=i=>{if("touch"==i.pointerType&&this._input!=INPUT.CURSOR)switch(this._input){case INPUT.ONE_FINGER:this.updateTouchEvent(i),this.onSinglePanMove(i,STATE.ROTATE);break;case INPUT.ONE_FINGER_SWITCHED:this.calculatePointersDistance(this._touchCurrent[0],i)*this._devPxRatio>=this._switchSensibility&&(this._input=INPUT.ONE_FINGER,this.updateTouchEvent(i),this.onSinglePanStart(i,"ROTATE"));break;case INPUT.TWO_FINGER:this.updateTouchEvent(i),this.onRotateMove(),this.onPinchMove(),this.onDoublePanMove();break;case INPUT.MULT_FINGER:this.updateTouchEvent(i),this.onTriplePanMove(i)}else if("touch"!=i.pointerType&&this._input==INPUT.CURSOR){let t=null;i.ctrlKey||i.metaKey?t="CTRL":i.shiftKey&&(t="SHIFT");var s=this.getOpStateFromAction(this._button,t);null!=s&&this.onSinglePanMove(i,s)}this._downValid&&this.calculatePointersDistance(this._downEvents[this._downEvents.length-1],i)*this._devPxRatio>this._movementThreshold&&(this._downValid=!1)};onPointerUp=i=>{if("touch"==i.pointerType&&this._input!=INPUT.CURSOR){var s=this._touchCurrent.length;for(let t=0;t<s;t++)if(this._touchCurrent[t].pointerId==i.pointerId){this._touchCurrent.splice(t,1),this._touchStart.splice(t,1);break}switch(this._input){case INPUT.ONE_FINGER:case INPUT.ONE_FINGER_SWITCHED:window.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerup",this.onPointerUp),this._input=INPUT.NONE,this.onSinglePanEnd();break;case INPUT.TWO_FINGER:this.onDoublePanEnd(i),this.onPinchEnd(i),this.onRotateEnd(i),this._input=INPUT.ONE_FINGER_SWITCHED;break;case INPUT.MULT_FINGER:0==this._touchCurrent.length&&(window.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerup",this.onPointerUp),this._input=INPUT.NONE,this.onTriplePanEnd())}}else"touch"!=i.pointerType&&this._input==INPUT.CURSOR&&(window.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerup",this.onPointerUp),this._input=INPUT.NONE,this.onSinglePanEnd(),this._button=-1);var t,e;i.isPrimary&&(this._downValid?i.timeStamp-this._downEvents[this._downEvents.length-1].timeStamp<=this._maxDownTime?0==this._nclicks?(this._nclicks=1,this._clickStart=performance.now()):(t=i.timeStamp-this._clickStart,e=this.calculatePointersDistance(this._downEvents[1],this._downEvents[0])*this._devPxRatio,t<=this._maxInterval&&e<=this._posThreshold?(this._nclicks=0,this._downEvents.splice(0,this._downEvents.length),this.onDoubleTap(i)):(this._nclicks=1,this._downEvents.shift(),this._clickStart=performance.now())):(this._downValid=!1,this._nclicks=0,this._downEvents.splice(0,this._downEvents.length)):(this._nclicks=0,this._downEvents.splice(0,this._downEvents.length)))};onWheel=s=>{if(this.enabled&&this.enableZoom){let t=null;s.ctrlKey||s.metaKey?t="CTRL":s.shiftKey&&(t="SHIFT");var e=this.getOpFromAction("WHEEL",t);if(null!=e){s.preventDefault(),this.dispatchEvent(_startEvent);var a=s.deltaY/125;let i=1;switch(0<a?i=1/this.scaleFactor:a<0&&(i=this.scaleFactor),e){case"ZOOM":if(this.updateTbState(STATE.SCALE,!0),0<a?i=1/Math.pow(this.scaleFactor,a):a<0&&(i=Math.pow(this.scaleFactor,-a)),this.cursorZoom&&this.enablePan){let t;this.camera.isOrthographicCamera?t=this.unprojectOnTbPlane(this.camera,s.clientX,s.clientY,this.domElement).applyQuaternion(this.camera.quaternion).multiplyScalar(1/this.camera.zoom).add(this._gizmos.position):this.camera.isPerspectiveCamera&&(t=this.unprojectOnTbPlane(this.camera,s.clientX,s.clientY,this.domElement).applyQuaternion(this.camera.quaternion).add(this._gizmos.position)),this.applyTransformMatrix(this.scale(i,t))}else this.applyTransformMatrix(this.scale(i,this._gizmos.position));null!=this._grid&&(this.disposeGrid(),this.drawGrid()),this.updateTbState(STATE.IDLE,!1),this.dispatchEvent(_changeEvent),this.dispatchEvent(_endEvent);break;case"FOV":if(this.camera.isPerspectiveCamera){this.updateTbState(STATE.FOV,!0),0!=s.deltaX&&(a=s.deltaX/125,i=1,0<a?i=1/Math.pow(this.scaleFactor,a):a<0&&(i=Math.pow(this.scaleFactor,-a))),this._v3_1.setFromMatrixPosition(this._cameraMatrixState);var o=this._v3_1.distanceTo(this._gizmos.position),r=o/i,r=MathUtils.clamp(r,this.minDistance,this.maxDistance),n=o*Math.tan(MathUtils.DEG2RAD*this.camera.fov*.5);let t=MathUtils.RAD2DEG*(2*Math.atan(n/r));t>this.maxFov?t=this.maxFov:t<this.minFov&&(t=this.minFov);r=n/Math.tan(MathUtils.DEG2RAD*(t/2));i=o/r,this.setFov(t),this.applyTransformMatrix(this.scale(i,this._gizmos.position,!1))}null!=this._grid&&(this.disposeGrid(),this.drawGrid()),this.updateTbState(STATE.IDLE,!1),this.dispatchEvent(_changeEvent),this.dispatchEvent(_endEvent)}}}};onSinglePanStart=(t,i)=>{if(this.enabled)switch(this.dispatchEvent(_startEvent),this.setCenter(t.clientX,t.clientY),i){case"PAN":this.enablePan&&(-1!=this._animationId&&(cancelAnimationFrame(this._animationId),this._animationId=-1,this._timeStart=-1,this.activateGizmos(!1),this.dispatchEvent(_changeEvent)),this.updateTbState(STATE.PAN,!0),this._startCursorPosition.copy(this.unprojectOnTbPlane(this.camera,_center.x,_center.y,this.domElement)),this.enableGrid&&(this.drawGrid(),this.dispatchEvent(_changeEvent)));break;case"ROTATE":this.enableRotate&&(-1!=this._animationId&&(cancelAnimationFrame(this._animationId),this._animationId=-1,this._timeStart=-1),this.updateTbState(STATE.ROTATE,!0),this._startCursorPosition.copy(this.unprojectOnTbSurface(this.camera,_center.x,_center.y,this.domElement,this._tbRadius)),this.activateGizmos(!0),this.enableAnimations&&(this._timePrev=this._timeCurrent=performance.now(),this._angleCurrent=this._anglePrev=0,this._cursorPosPrev.copy(this._startCursorPosition),this._cursorPosCurr.copy(this._cursorPosPrev),this._wCurr=0,this._wPrev=this._wCurr),this.dispatchEvent(_changeEvent));break;case"FOV":this.camera.isPerspectiveCamera&&this.enableZoom&&(-1!=this._animationId&&(cancelAnimationFrame(this._animationId),this._animationId=-1,this._timeStart=-1,this.activateGizmos(!1),this.dispatchEvent(_changeEvent)),this.updateTbState(STATE.FOV,!0),this._startCursorPosition.setY(.5*this.getCursorNDC(_center.x,_center.y,this.domElement).y),this._currentCursorPosition.copy(this._startCursorPosition));break;case"ZOOM":this.enableZoom&&(-1!=this._animationId&&(cancelAnimationFrame(this._animationId),this._animationId=-1,this._timeStart=-1,this.activateGizmos(!1),this.dispatchEvent(_changeEvent)),this.updateTbState(STATE.SCALE,!0),this._startCursorPosition.setY(.5*this.getCursorNDC(_center.x,_center.y,this.domElement).y),this._currentCursorPosition.copy(this._startCursorPosition))}};onSinglePanMove=(t,i)=>{if(this.enabled){var s=i!=this._state;switch(this.setCenter(t.clientX,t.clientY),i){case STATE.PAN:this.enablePan&&(s?(this.dispatchEvent(_endEvent),this.dispatchEvent(_startEvent),this.updateTbState(i,!0),this._startCursorPosition.copy(this.unprojectOnTbPlane(this.camera,_center.x,_center.y,this.domElement)),this.enableGrid&&this.drawGrid(),this.activateGizmos(!1)):(this._currentCursorPosition.copy(this.unprojectOnTbPlane(this.camera,_center.x,_center.y,this.domElement)),this.applyTransformMatrix(this.pan(this._startCursorPosition,this._currentCursorPosition))));break;case STATE.ROTATE:this.enableRotate&&(s?(this.dispatchEvent(_endEvent),this.dispatchEvent(_startEvent),this.updateTbState(i,!0),this._startCursorPosition.copy(this.unprojectOnTbSurface(this.camera,_center.x,_center.y,this.domElement,this._tbRadius)),this.enableGrid&&this.disposeGrid(),this.activateGizmos(!0)):(this._currentCursorPosition.copy(this.unprojectOnTbSurface(this.camera,_center.x,_center.y,this.domElement,this._tbRadius)),a=this._startCursorPosition.distanceTo(this._currentCursorPosition),e=this._startCursorPosition.angleTo(this._currentCursorPosition),a=Math.max(a/this._tbRadius,e),this.applyTransformMatrix(this.rotate(this.calculateRotationAxis(this._startCursorPosition,this._currentCursorPosition),a)),this.enableAnimations&&(this._timePrev=this._timeCurrent,this._timeCurrent=performance.now(),this._anglePrev=this._angleCurrent,this._angleCurrent=a,this._cursorPosPrev.copy(this._cursorPosCurr),this._cursorPosCurr.copy(this._currentCursorPosition),this._wPrev=this._wCurr,this._wCurr=this.calculateAngularSpeed(this._anglePrev,this._angleCurrent,this._timePrev,this._timeCurrent))));break;case STATE.SCALE:if(this.enableZoom)if(s)this.dispatchEvent(_endEvent),this.dispatchEvent(_startEvent),this.updateTbState(i,!0),this._startCursorPosition.setY(.5*this.getCursorNDC(_center.x,_center.y,this.domElement).y),this._currentCursorPosition.copy(this._startCursorPosition),this.enableGrid&&this.disposeGrid(),this.activateGizmos(!1);else{this._currentCursorPosition.setY(.5*this.getCursorNDC(_center.x,_center.y,this.domElement).y);var e=this._currentCursorPosition.y-this._startCursorPosition.y;let t=1;e<0?t=1/Math.pow(this.scaleFactor,8*-e):0<e&&(t=Math.pow(this.scaleFactor,8*e)),this._v3_1.setFromMatrixPosition(this._gizmoMatrixState),this.applyTransformMatrix(this.scale(t,this._v3_1))}break;case STATE.FOV:if(this.enableZoom&&this.camera.isPerspectiveCamera)if(s)this.dispatchEvent(_endEvent),this.dispatchEvent(_startEvent),this.updateTbState(i,!0),this._startCursorPosition.setY(.5*this.getCursorNDC(_center.x,_center.y,this.domElement).y),this._currentCursorPosition.copy(this._startCursorPosition),this.enableGrid&&this.disposeGrid(),this.activateGizmos(!1);else{this._currentCursorPosition.setY(.5*this.getCursorNDC(_center.x,_center.y,this.domElement).y);var a=this._currentCursorPosition.y-this._startCursorPosition.y;let t=1;a<0?t=1/Math.pow(this.scaleFactor,8*-a):0<a&&(t=Math.pow(this.scaleFactor,8*a)),this._v3_1.setFromMatrixPosition(this._cameraMatrixState);var e=this._v3_1.distanceTo(this._gizmos.position),a=e/t,a=MathUtils.clamp(a,this.minDistance,this.maxDistance),o=e*Math.tan(MathUtils.DEG2RAD*this._fovState*.5),a=MathUtils.RAD2DEG*(2*Math.atan(o/a)),a=MathUtils.clamp(a,this.minFov,this.maxFov),o=o/Math.tan(MathUtils.DEG2RAD*(a/2));t=e/o,this._v3_2.setFromMatrixPosition(this._gizmoMatrixState),this.setFov(a),this.applyTransformMatrix(this.scale(t,this._v3_2,!1)),_offset.copy(this._gizmos.position).sub(this.camera.position).normalize().multiplyScalar(o/e),this._m4_1.makeTranslation(_offset.x,_offset.y,_offset.z)}}this.dispatchEvent(_changeEvent)}};onSinglePanEnd=()=>{if(this._state==STATE.ROTATE){if(!this.enableRotate)return;if(this.enableAnimations)if(performance.now()-this._timeCurrent<120){const s=Math.abs((this._wPrev+this._wCurr)/2),e=this;this._animationId=window.requestAnimationFrame(function(t){e.updateTbState(STATE.ANIMATION_ROTATE,!0);var i=e.calculateRotationAxis(e._cursorPosPrev,e._cursorPosCurr);e.onRotationAnim(t,i,Math.min(s,e.wMax))})}else this.updateTbState(STATE.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(_changeEvent);else this.updateTbState(STATE.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(_changeEvent)}else this._state!=STATE.PAN&&this._state!=STATE.IDLE||(this.updateTbState(STATE.IDLE,!1),this.enableGrid&&this.disposeGrid(),this.activateGizmos(!1),this.dispatchEvent(_changeEvent));this.dispatchEvent(_endEvent)};onDoubleTap=t=>{if(this.enabled&&this.enablePan&&null!=this.scene){this.dispatchEvent(_startEvent),this.setCenter(t.clientX,t.clientY);const i=this.unprojectOnObj(this.getCursorNDC(_center.x,_center.y,this.domElement),this.camera);if(null!=i&&this.enableAnimations){const s=this;-1!=this._animationId&&window.cancelAnimationFrame(this._animationId),this._timeStart=-1,this._animationId=window.requestAnimationFrame(function(t){s.updateTbState(STATE.ANIMATION_FOCUS,!0),s.onFocusAnim(t,i,s._cameraMatrixState,s._gizmoMatrixState)})}else null==i||this.enableAnimations||(this.updateTbState(STATE.FOCUS,!0),this.focus(i,this.scaleFactor),this.updateTbState(STATE.IDLE,!1),this.dispatchEvent(_changeEvent))}this.dispatchEvent(_endEvent)};onDoublePanStart=()=>{this.enabled&&this.enablePan&&(this.dispatchEvent(_startEvent),this.updateTbState(STATE.PAN,!0),this.setCenter((this._touchCurrent[0].clientX+this._touchCurrent[1].clientX)/2,(this._touchCurrent[0].clientY+this._touchCurrent[1].clientY)/2),this._startCursorPosition.copy(this.unprojectOnTbPlane(this.camera,_center.x,_center.y,this.domElement,!0)),this._currentCursorPosition.copy(this._startCursorPosition),this.activateGizmos(!1))};onDoublePanMove=()=>{this.enabled&&this.enablePan&&(this.setCenter((this._touchCurrent[0].clientX+this._touchCurrent[1].clientX)/2,(this._touchCurrent[0].clientY+this._touchCurrent[1].clientY)/2),this._state!=STATE.PAN&&(this.updateTbState(STATE.PAN,!0),this._startCursorPosition.copy(this._currentCursorPosition)),this._currentCursorPosition.copy(this.unprojectOnTbPlane(this.camera,_center.x,_center.y,this.domElement,!0)),this.applyTransformMatrix(this.pan(this._startCursorPosition,this._currentCursorPosition,!0)),this.dispatchEvent(_changeEvent))};onDoublePanEnd=()=>{this.updateTbState(STATE.IDLE,!1),this.dispatchEvent(_endEvent)};onRotateStart=()=>{this.enabled&&this.enableRotate&&(this.dispatchEvent(_startEvent),this.updateTbState(STATE.ZROTATE,!0),this._startFingerRotation=this.getAngle(this._touchCurrent[1],this._touchCurrent[0])+this.getAngle(this._touchStart[1],this._touchStart[0]),this._currentFingerRotation=this._startFingerRotation,this.camera.getWorldDirection(this._rotationAxis),this.enablePan||this.enableZoom||this.activateGizmos(!0))};onRotateMove=()=>{if(this.enabled&&this.enableRotate){this.setCenter((this._touchCurrent[0].clientX+this._touchCurrent[1].clientX)/2,(this._touchCurrent[0].clientY+this._touchCurrent[1].clientY)/2);let t;this._state!=STATE.ZROTATE&&(this.updateTbState(STATE.ZROTATE,!0),this._startFingerRotation=this._currentFingerRotation),this._currentFingerRotation=this.getAngle(this._touchCurrent[1],this._touchCurrent[0])+this.getAngle(this._touchStart[1],this._touchStart[0]),t=this.enablePan?(this._v3_2.setFromMatrixPosition(this._gizmoMatrixState),this.unprojectOnTbPlane(this.camera,_center.x,_center.y,this.domElement).applyQuaternion(this.camera.quaternion).multiplyScalar(1/this.camera.zoom).add(this._v3_2)):(new Vector3).setFromMatrixPosition(this._gizmoMatrixState);var i=MathUtils.DEG2RAD*(this._startFingerRotation-this._currentFingerRotation);this.applyTransformMatrix(this.zRotate(t,i)),this.dispatchEvent(_changeEvent)}};onRotateEnd=()=>{this.updateTbState(STATE.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(_endEvent)};onPinchStart=()=>{this.enabled&&this.enableZoom&&(this.dispatchEvent(_startEvent),this.updateTbState(STATE.SCALE,!0),this._startFingerDistance=this.calculatePointersDistance(this._touchCurrent[0],this._touchCurrent[1]),this._currentFingerDistance=this._startFingerDistance,this.activateGizmos(!1))};onPinchMove=()=>{if(this.enabled&&this.enableZoom){this.setCenter((this._touchCurrent[0].clientX+this._touchCurrent[1].clientX)/2,(this._touchCurrent[0].clientY+this._touchCurrent[1].clientY)/2);this._state!=STATE.SCALE&&(this._startFingerDistance=this._currentFingerDistance,this.updateTbState(STATE.SCALE,!0)),this._currentFingerDistance=Math.max(this.calculatePointersDistance(this._touchCurrent[0],this._touchCurrent[1]),12*this._devPxRatio);var i=this._currentFingerDistance/this._startFingerDistance;let t;this.enablePan?this.camera.isOrthographicCamera?t=this.unprojectOnTbPlane(this.camera,_center.x,_center.y,this.domElement).applyQuaternion(this.camera.quaternion).multiplyScalar(1/this.camera.zoom).add(this._gizmos.position):this.camera.isPerspectiveCamera&&(t=this.unprojectOnTbPlane(this.camera,_center.x,_center.y,this.domElement).applyQuaternion(this.camera.quaternion).add(this._gizmos.position)):t=this._gizmos.position,this.applyTransformMatrix(this.scale(i,t)),this.dispatchEvent(_changeEvent)}};onPinchEnd=()=>{this.updateTbState(STATE.IDLE,!1),this.dispatchEvent(_endEvent)};onTriplePanStart=()=>{if(this.enabled&&this.enableZoom){this.dispatchEvent(_startEvent),this.updateTbState(STATE.SCALE,!0);let i=0,s=0;var e=this._touchCurrent.length;for(let t=0;t<e;t++)i+=this._touchCurrent[t].clientX,s+=this._touchCurrent[t].clientY;this.setCenter(i/e,s/e),this._startCursorPosition.setY(.5*this.getCursorNDC(_center.x,_center.y,this.domElement).y),this._currentCursorPosition.copy(this._startCursorPosition)}};onTriplePanMove=()=>{if(this.enabled&&this.enableZoom){let i=0,s=0;var e=this._touchCurrent.length;for(let t=0;t<e;t++)i+=this._touchCurrent[t].clientX,s+=this._touchCurrent[t].clientY;this.setCenter(i/e,s/e);this._currentCursorPosition.setY(.5*this.getCursorNDC(_center.x,_center.y,this.domElement).y);var a=this._currentCursorPosition.y-this._startCursorPosition.y;let t=1;a<0?t=1/Math.pow(this.scaleFactor,8*-a):0<a&&(t=Math.pow(this.scaleFactor,8*a)),this._v3_1.setFromMatrixPosition(this._cameraMatrixState);var a=this._v3_1.distanceTo(this._gizmos.position),o=a/t,o=MathUtils.clamp(o,this.minDistance,this.maxDistance),r=a*Math.tan(MathUtils.DEG2RAD*this._fovState*.5),o=MathUtils.RAD2DEG*(2*Math.atan(r/o)),o=MathUtils.clamp(o,this.minFov,this.maxFov),r=r/Math.tan(MathUtils.DEG2RAD*(o/2));t=a/r,this._v3_2.setFromMatrixPosition(this._gizmoMatrixState),this.setFov(o),this.applyTransformMatrix(this.scale(t,this._v3_2,!1)),_offset.copy(this._gizmos.position).sub(this.camera.position).normalize().multiplyScalar(r/a),this._m4_1.makeTranslation(_offset.x,_offset.y,_offset.z),this.dispatchEvent(_changeEvent)}};onTriplePanEnd=()=>{this.updateTbState(STATE.IDLE,!1),this.dispatchEvent(_endEvent)};setCenter=(t,i)=>{_center.x=t,_center.y=i};initializeMouseActions=()=>{this.setMouseAction("PAN",0,"CTRL"),this.setMouseAction("PAN",2),this.setMouseAction("ROTATE",0),this.setMouseAction("ZOOM","WHEEL"),this.setMouseAction("ZOOM",1),this.setMouseAction("FOV","WHEEL","SHIFT"),this.setMouseAction("FOV",1,"SHIFT")};compareMouseAction=(t,i)=>t.operation==i.operation&&(t.mouse==i.mouse&&t.key==i.key);setMouseAction=(t,i,s=null)=>{let e;if(!["PAN","ROTATE","ZOOM","FOV"].includes(t)||![0,1,2,"WHEEL"].includes(i)||!["CTRL","SHIFT",null].includes(s))return!1;if("WHEEL"==i&&"ZOOM"!=t&&"FOV"!=t)return!1;switch(t){case"PAN":e=STATE.PAN;break;case"ROTATE":e=STATE.ROTATE;break;case"ZOOM":e=STATE.SCALE;break;case"FOV":e=STATE.FOV}var a={operation:t,mouse:i,key:s,state:e};for(let t=0;t<this.mouseActions.length;t++)if(this.mouseActions[t].mouse==a.mouse&&this.mouseActions[t].key==a.key)return this.mouseActions.splice(t,1,a),!0;return this.mouseActions.push(a),!0};unsetMouseAction=(i,s=null)=>{for(let t=0;t<this.mouseActions.length;t++)if(this.mouseActions[t].mouse==i&&this.mouseActions[t].key==s)return this.mouseActions.splice(t,1),!0;return!1};getOpFromAction=(i,s)=>{let e;for(let t=0;t<this.mouseActions.length;t++)if((e=this.mouseActions[t]).mouse==i&&e.key==s)return e.operation;if(null!=s)for(let t=0;t<this.mouseActions.length;t++)if((e=this.mouseActions[t]).mouse==i&&null==e.key)return e.operation;return null};getOpStateFromAction=(i,s)=>{let e;for(let t=0;t<this.mouseActions.length;t++)if((e=this.mouseActions[t]).mouse==i&&e.key==s)return e.state;if(null!=s)for(let t=0;t<this.mouseActions.length;t++)if((e=this.mouseActions[t]).mouse==i&&null==e.key)return e.state;return null};getAngle=(t,i)=>180*Math.atan2(i.clientY-t.clientY,i.clientX-t.clientX)/Math.PI;updateTouchEvent=i=>{for(let t=0;t<this._touchCurrent.length;t++)if(this._touchCurrent[t].pointerId==i.pointerId){this._touchCurrent.splice(t,1,i);break}};applyTransformMatrix(t){if(null!=t.camera&&(this._m4_1.copy(this._cameraMatrixState).premultiply(t.camera),this._m4_1.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.camera.updateMatrix(),this._state!=STATE.ROTATE&&this._state!=STATE.ZROTATE&&this._state!=STATE.ANIMATION_ROTATE||this.camera.up.copy(this._upState).applyQuaternion(this.camera.quaternion)),null!=t.gizmos&&(this._m4_1.copy(this._gizmoMatrixState).premultiply(t.gizmos),this._m4_1.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this._gizmos.updateMatrix()),this._state==STATE.SCALE||this._state==STATE.FOCUS||this._state==STATE.ANIMATION_FOCUS)if(this._tbRadius=this.calculateTbRadius(this.camera),this.adjustNearFar){var t=this.camera.position.distanceTo(this._gizmos.position),i=new Box3,s=(i.setFromObject(this._gizmos),new Sphere),i=(i.getBoundingSphere(s),Math.max(this._nearPos0,s.radius+s.center.length())),e=t-this._initialNear,i=Math.min(i,e),e=(this.camera.near=t-i,Math.min(this._farPos0,-s.radius+s.center.length())),i=t-this._initialFar,s=Math.min(e,i);this.camera.far=t-s,this.camera.updateProjectionMatrix()}else{let t=!1;this.camera.near!=this._initialNear&&(this.camera.near=this._initialNear,t=!0),this.camera.far!=this._initialFar&&(this.camera.far=this._initialFar,t=!0),t&&this.camera.updateProjectionMatrix()}}calculateAngularSpeed=(t,i,s,e)=>{e=(e-s)/1e3;return 0==e?0:(i-t)/e};calculatePointersDistance=(t,i)=>Math.sqrt(Math.pow(i.clientX-t.clientX,2)+Math.pow(i.clientY-t.clientY,2));calculateRotationAxis=(t,i)=>(this._rotationMatrix.extractRotation(this._cameraMatrixState),this._quat.setFromRotationMatrix(this._rotationMatrix),this._rotationAxis.crossVectors(t,i).applyQuaternion(this._quat),this._rotationAxis.normalize().clone());calculateTbRadius=t=>{var i,s,e=t.position.distanceTo(this._gizmos.position);return"PerspectiveCamera"==t.type?(i=MathUtils.DEG2RAD*t.fov*.5,s=Math.atan(t.aspect*Math.tan(i)),Math.tan(Math.min(i,s))*e*this.radiusFactor):"OrthographicCamera"==t.type?Math.min(t.top,t.right)*this.radiusFactor:void 0};focus=(t,i,s=1)=>{_offset.copy(t).sub(this._gizmos.position).multiplyScalar(s),this._translationMatrix.makeTranslation(_offset.x,_offset.y,_offset.z),_gizmoMatrixStateTemp.copy(this._gizmoMatrixState),this._gizmoMatrixState.premultiply(this._translationMatrix),this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),_cameraMatrixStateTemp.copy(this._cameraMatrixState),this._cameraMatrixState.premultiply(this._translationMatrix),this._cameraMatrixState.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.enableZoom&&this.applyTransformMatrix(this.scale(i,this._gizmos.position)),this._gizmoMatrixState.copy(_gizmoMatrixStateTemp),this._cameraMatrixState.copy(_cameraMatrixStateTemp)};drawGrid=()=>{if(null!=this.scene){var a,o,r;let t,i,s,e;this.camera.isOrthographicCamera?(a=this.camera.right-this.camera.left,o=this.camera.bottom-this.camera.top,s=Math.max(a,o),e=s/20,t=s/this.camera.zoom*3,i=t/e*this.camera.zoom):this.camera.isPerspectiveCamera&&(a=this.camera.position.distanceTo(this._gizmos.position),o=MathUtils.DEG2RAD*this.camera.fov*.5,r=Math.atan(this.camera.aspect*Math.tan(o)),s=Math.tan(Math.max(o,r))*a*2,e=s/20,t=3*s,i=t/e),null==this._grid&&(this._grid=new GridHelper(t,i,8947848,8947848),this._grid.position.copy(this._gizmos.position),this._gridPosition.copy(this._grid.position),this._grid.quaternion.copy(this.camera.quaternion),this._grid.rotateX(.5*Math.PI),this.scene.add(this._grid))}};dispose=()=>{-1!=this._animationId&&window.cancelAnimationFrame(this._animationId),this.domElement.removeEventListener("pointerdown",this.onPointerDown),this.domElement.removeEventListener("pointercancel",this.onPointerCancel),this.domElement.removeEventListener("wheel",this.onWheel),this.domElement.removeEventListener("contextmenu",this.onContextMenu),window.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerup",this.onPointerUp),window.removeEventListener("resize",this.onWindowResize),null!==this.scene&&this.scene.remove(this._gizmos),this.disposeGrid()};disposeGrid=()=>{null!=this._grid&&null!=this.scene&&(this.scene.remove(this._grid),this._grid=null)};easeOutCubic=t=>1-Math.pow(1-t,3);activateGizmos=t=>{var i=this._gizmos.children[0],s=this._gizmos.children[1],e=this._gizmos.children[2];t?(i.material.setValues({opacity:1}),s.material.setValues({opacity:1}),e.material.setValues({opacity:1})):(i.material.setValues({opacity:.6}),s.material.setValues({opacity:.6}),e.material.setValues({opacity:.6}))};getCursorNDC=(t,i,s)=>{s=s.getBoundingClientRect();return this._v2_1.setX((t-s.left)/s.width*2-1),this._v2_1.setY((s.bottom-i)/s.height*2-1),this._v2_1.clone()};getCursorPosition=(t,i,s)=>(this._v2_1.copy(this.getCursorNDC(t,i,s)),this._v2_1.x*=.5*(this.camera.right-this.camera.left),this._v2_1.y*=.5*(this.camera.top-this.camera.bottom),this._v2_1.clone());setCamera=t=>{t.lookAt(this.target),t.updateMatrix(),"PerspectiveCamera"==t.type&&(this._fov0=t.fov,this._fovState=t.fov),this._cameraMatrixState0.copy(t.matrix),this._cameraMatrixState.copy(this._cameraMatrixState0),this._cameraProjectionState.copy(t.projectionMatrix),this._zoom0=t.zoom,this._zoomState=this._zoom0,this._initialNear=t.near,this._nearPos0=t.position.distanceTo(this.target)-t.near,this._nearPos=this._initialNear,this._initialFar=t.far,this._farPos0=t.position.distanceTo(this.target)-t.far,this._farPos=this._initialFar,this._up0.copy(t.up),this._upState.copy(t.up),this.camera=t,this.camera.updateProjectionMatrix(),this._tbRadius=this.calculateTbRadius(t),this.makeGizmos(this.target,this._tbRadius)};setGizmosVisible(t){this._gizmos.visible=t,this.dispatchEvent(_changeEvent)}setTbRadius(t){this.radiusFactor=t,this._tbRadius=this.calculateTbRadius(this.camera);var t=new EllipseCurve(0,0,this._tbRadius,this._tbRadius).getPoints(this._curvePts),i=(new BufferGeometry).setFromPoints(t);for(const s in this._gizmos.children)this._gizmos.children[s].geometry=i;this.dispatchEvent(_changeEvent)}makeGizmos=(t,i)=>{var i=new EllipseCurve(0,0,i,i).getPoints(this._curvePts),i=(new BufferGeometry).setFromPoints(i),s=new LineBasicMaterial({color:16744576,fog:!1,transparent:!0,opacity:.6}),e=new LineBasicMaterial({color:8454016,fog:!1,transparent:!0,opacity:.6}),a=new LineBasicMaterial({color:8421631,fog:!1,transparent:!0,opacity:.6}),s=new Line(i,s),e=new Line(i,e),i=new Line(i,a),a=.5*Math.PI;s.rotation.x=a,e.rotation.y=a,this._gizmoMatrixState0.identity().setPosition(t),this._gizmoMatrixState.copy(this._gizmoMatrixState0),1!==this.camera.zoom&&(a=1/this.camera.zoom,this._scaleMatrix.makeScale(a,a,a),this._translationMatrix.makeTranslation(-t.x,-t.y,-t.z),this._gizmoMatrixState.premultiply(this._translationMatrix).premultiply(this._scaleMatrix),this._translationMatrix.makeTranslation(t.x,t.y,t.z),this._gizmoMatrixState.premultiply(this._translationMatrix)),this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this._gizmos.traverse(function(t){t.isLine&&(t.geometry.dispose(),t.material.dispose())}),this._gizmos.clear(),this._gizmos.add(s),this._gizmos.add(e),this._gizmos.add(i)};onFocusAnim=(t,i,s,e)=>{if(-1==this._timeStart&&(this._timeStart=t),this._state==STATE.ANIMATION_FOCUS){t=(t-this._timeStart)/this.focusAnimationTime;if(this._gizmoMatrixState.copy(e),1<=t)this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this.focus(i,this.scaleFactor),this._timeStart=-1,this.updateTbState(STATE.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(_changeEvent);else{var t=this.easeOutCubic(t),a=1-t+this.scaleFactor*t;this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this.focus(i,a,t),this.dispatchEvent(_changeEvent);const o=this;this._animationId=window.requestAnimationFrame(function(t){o.onFocusAnim(t,i,s,e.clone())})}}else this._animationId=-1,this._timeStart=-1};onRotationAnim=(t,i,s)=>{if(-1==this._timeStart&&(this._anglePrev=0,this._angleCurrent=0,this._timeStart=t),this._state==STATE.ANIMATION_ROTATE){t=(t-this._timeStart)/1e3;if(0<s+-this.dampingFactor*t){this._angleCurrent=.5*-this.dampingFactor*Math.pow(t,2)+s*t,this.applyTransformMatrix(this.rotate(i,this._angleCurrent)),this.dispatchEvent(_changeEvent);const e=this;this._animationId=window.requestAnimationFrame(function(t){e.onRotationAnim(t,i,s)})}else this._animationId=-1,this._timeStart=-1,this.updateTbState(STATE.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(_changeEvent)}else this._animationId=-1,this._timeStart=-1,this._state!=STATE.ROTATE&&(this.activateGizmos(!1),this.dispatchEvent(_changeEvent))};pan=(t,i,s=!1)=>{t=t.clone().sub(i);return this.camera.isOrthographicCamera?t.multiplyScalar(1/this.camera.zoom):this.camera.isPerspectiveCamera&&s&&(this._v3_1.setFromMatrixPosition(this._cameraMatrixState0),this._v3_2.setFromMatrixPosition(this._gizmoMatrixState0),i=this._v3_1.distanceTo(this._v3_2)/this.camera.position.distanceTo(this._gizmos.position),t.multiplyScalar(1/i)),this._v3_1.set(t.x,t.y,0).applyQuaternion(this.camera.quaternion),this._m4_1.makeTranslation(this._v3_1.x,this._v3_1.y,this._v3_1.z),this.setTransformationMatrices(this._m4_1,this._m4_1),_transformation};reset=()=>{this.camera.zoom=this._zoom0,this.camera.isPerspectiveCamera&&(this.camera.fov=this._fov0),this.camera.near=this._nearPos,this.camera.far=this._farPos,this._cameraMatrixState.copy(this._cameraMatrixState0),this._cameraMatrixState.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.camera.up.copy(this._up0),this.camera.updateMatrix(),this.camera.updateProjectionMatrix(),this._gizmoMatrixState.copy(this._gizmoMatrixState0),this._gizmoMatrixState0.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this._gizmos.updateMatrix(),this._tbRadius=this.calculateTbRadius(this.camera),this.makeGizmos(this._gizmos.position,this._tbRadius),this.camera.lookAt(this._gizmos.position),this.updateTbState(STATE.IDLE,!1),this.dispatchEvent(_changeEvent)};rotate=(t,i)=>{var s=this._gizmos.position;return this._translationMatrix.makeTranslation(-s.x,-s.y,-s.z),this._rotationMatrix.makeRotationAxis(t,-i),this._m4_1.makeTranslation(s.x,s.y,s.z),this._m4_1.multiply(this._rotationMatrix),this._m4_1.multiply(this._translationMatrix),this.setTransformationMatrices(this._m4_1),_transformation};copyState=()=>{let t;this.camera.isOrthographicCamera?t=JSON.stringify({arcballState:{cameraFar:this.camera.far,cameraMatrix:this.camera.matrix,cameraNear:this.camera.near,cameraUp:this.camera.up,cameraZoom:this.camera.zoom,gizmoMatrix:this._gizmos.matrix}}):this.camera.isPerspectiveCamera&&(t=JSON.stringify({arcballState:{cameraFar:this.camera.far,cameraFov:this.camera.fov,cameraMatrix:this.camera.matrix,cameraNear:this.camera.near,cameraUp:this.camera.up,cameraZoom:this.camera.zoom,gizmoMatrix:this._gizmos.matrix}})),navigator.clipboard.writeText(t)};pasteState=()=>{const i=this;navigator.clipboard.readText().then(function(t){i.setStateFromJSON(t)})};saveState=()=>{this._cameraMatrixState0.copy(this.camera.matrix),this._gizmoMatrixState0.copy(this._gizmos.matrix),this._nearPos=this.camera.near,this._farPos=this.camera.far,this._zoom0=this.camera.zoom,this._up0.copy(this.camera.up),this.camera.isPerspectiveCamera&&(this._fov0=this.camera.fov)};scale=(i,s,e=!0)=>{_scalePointTemp.copy(s);let a=1/i;if(this.camera.isOrthographicCamera)return this.camera.zoom=this._zoomState,this.camera.zoom*=i,this.camera.zoom>this.maxZoom?(this.camera.zoom=this.maxZoom,a=this._zoomState/this.maxZoom):this.camera.zoom<this.minZoom&&(this.camera.zoom=this.minZoom,a=this._zoomState/this.minZoom),this.camera.updateProjectionMatrix(),this._v3_1.setFromMatrixPosition(this._gizmoMatrixState),this._scaleMatrix.makeScale(a,a,a),this._translationMatrix.makeTranslation(-this._v3_1.x,-this._v3_1.y,-this._v3_1.z),this._m4_2.makeTranslation(this._v3_1.x,this._v3_1.y,this._v3_1.z).multiply(this._scaleMatrix),this._m4_2.multiply(this._translationMatrix),_scalePointTemp.sub(this._v3_1),s=_scalePointTemp.clone().multiplyScalar(a),_scalePointTemp.sub(s),this._m4_1.makeTranslation(_scalePointTemp.x,_scalePointTemp.y,_scalePointTemp.z),this._m4_2.premultiply(this._m4_1),this.setTransformationMatrices(this._m4_1,this._m4_2),_transformation;if(this.camera.isPerspectiveCamera){this._v3_1.setFromMatrixPosition(this._cameraMatrixState),this._v3_2.setFromMatrixPosition(this._gizmoMatrixState);i=this._v3_1.distanceTo(_scalePointTemp);let t=i-i*a;var s=i-t;return s<this.minDistance?(a=this.minDistance/i,t=i-i*a):s>this.maxDistance&&(a=this.maxDistance/i,t=i-i*a),_offset.copy(_scalePointTemp).sub(this._v3_1).normalize().multiplyScalar(t),this._m4_1.makeTranslation(_offset.x,_offset.y,_offset.z),e?(i=(s=this._v3_2).distanceTo(_scalePointTemp),t=i-i*a,_offset.copy(_scalePointTemp).sub(this._v3_2).normalize().multiplyScalar(t),this._translationMatrix.makeTranslation(s.x,s.y,s.z),this._scaleMatrix.makeScale(a,a,a),this._m4_2.makeTranslation(_offset.x,_offset.y,_offset.z).multiply(this._translationMatrix),this._m4_2.multiply(this._scaleMatrix),this._translationMatrix.makeTranslation(-s.x,-s.y,-s.z),this._m4_2.multiply(this._translationMatrix),this.setTransformationMatrices(this._m4_1,this._m4_2)):this.setTransformationMatrices(this._m4_1),_transformation}};setFov=t=>{this.camera.isPerspectiveCamera&&(this.camera.fov=MathUtils.clamp(t,this.minFov,this.maxFov),this.camera.updateProjectionMatrix())};setTransformationMatrices(t=null,i=null){null!=t?null!=_transformation.camera?_transformation.camera.copy(t):_transformation.camera=t.clone():_transformation.camera=null,null!=i?null!=_transformation.gizmos?_transformation.gizmos.copy(i):_transformation.gizmos=i.clone():_transformation.gizmos=null}zRotate=(t,i)=>(this._rotationMatrix.makeRotationAxis(this._rotationAxis,i),this._translationMatrix.makeTranslation(-t.x,-t.y,-t.z),this._m4_1.makeTranslation(t.x,t.y,t.z),this._m4_1.multiply(this._rotationMatrix),this._m4_1.multiply(this._translationMatrix),this._v3_1.setFromMatrixPosition(this._gizmoMatrixState).sub(t),this._v3_2.copy(this._v3_1).applyAxisAngle(this._rotationAxis,i),this._v3_2.sub(this._v3_1),this._m4_2.makeTranslation(this._v3_2.x,this._v3_2.y,this._v3_2.z),this.setTransformationMatrices(this._m4_1,this._m4_2),_transformation);getRaycaster(){return _raycaster}unprojectOnObj=(t,i)=>{var s=this.getRaycaster(),e=(s.near=i.near,s.far=i.far,s.setFromCamera(t,i),s.intersectObjects(this.scene.children,!0));for(let t=0;t<e.length;t++)if(e[t].object.uuid!=this._gizmos.uuid&&null!=e[t].face)return e[t].point.clone();return null};unprojectOnTbSurface=(t,i,s,e,a)=>{if("OrthographicCamera"==t.type)return this._v2_1.copy(this.getCursorPosition(i,s,e)),this._v3_1.set(this._v2_1.x,this._v2_1.y,0),(r=Math.pow(this._v2_1.x,2))+(n=Math.pow(this._v2_1.y,2))<=.5*(o=Math.pow(this._tbRadius,2))?this._v3_1.setZ(Math.sqrt(o-(r+n))):this._v3_1.setZ(.5*o/Math.sqrt(r+n)),this._v3_1;if("PerspectiveCamera"==t.type){this._v2_1.copy(this.getCursorNDC(i,s,e)),this._v3_1.set(this._v2_1.x,this._v2_1.y,-1),this._v3_1.applyMatrix4(t.projectionMatrixInverse);var o=this._v3_1.clone().normalize(),r=t.position.distanceTo(this._gizmos.position),n=Math.pow(a,2),i=this._v3_1.z,s=Math.sqrt(Math.pow(this._v3_1.x,2)+Math.pow(this._v3_1.y,2));if(0==s)o.set(this._v3_1.x,this._v3_1.y,a);else{var e=i/s,t=r,a=Math.pow(e,2)+1,i=2*e*t,s=Math.pow(t,2)-n,h=Math.pow(i,2)-4*a*s;if(0<=h)if(this._v2_1.setX((-i-Math.sqrt(h))/(2*a)),this._v2_1.setY(e*this._v2_1.x+t),45<=MathUtils.RAD2DEG*this._v2_1.angle())return c=Math.sqrt(Math.pow(this._v2_1.x,2)+Math.pow(r-this._v2_1.y,2)),o.multiplyScalar(c),o.z+=r,o;a=e,i=t,s=.5*-n,h=Math.pow(i,2)-4*a*s,this._v2_1.setX((-i-Math.sqrt(h))/(2*a)),this._v2_1.setY(e*this._v2_1.x+t);var c=Math.sqrt(Math.pow(this._v2_1.x,2)+Math.pow(r-this._v2_1.y,2));o.multiplyScalar(c),o.z+=r}return o}};unprojectOnTbPlane=(i,s,e,a,o=!1)=>{if("OrthographicCamera"==i.type)return this._v2_1.copy(this.getCursorPosition(s,e,a)),this._v3_1.set(this._v2_1.x,this._v2_1.y,0),this._v3_1.clone();if("PerspectiveCamera"==i.type){this._v2_1.copy(this.getCursorNDC(s,e,a)),this._v3_1.set(this._v2_1.x,this._v2_1.y,-1),this._v3_1.applyMatrix4(i.projectionMatrixInverse);var s=this._v3_1.clone().normalize(),e=this._v3_1.z,a=Math.sqrt(Math.pow(this._v3_1.x,2)+Math.pow(this._v3_1.y,2));let t;return t=o?this._v3_1.setFromMatrixPosition(this._cameraMatrixState0).distanceTo(this._v3_2.setFromMatrixPosition(this._gizmoMatrixState0)):i.position.distanceTo(this._gizmos.position),0==a?s.set(0,0,0):(i=-(o=t)/(e/a),e=Math.sqrt(Math.pow(o,2)+Math.pow(i,2)),s.multiplyScalar(e),s.z=0),s}};updateMatrixState=()=>{this._cameraMatrixState.copy(this.camera.matrix),this._gizmoMatrixState.copy(this._gizmos.matrix),this.camera.isOrthographicCamera?(this._cameraProjectionState.copy(this.camera.projectionMatrix),this.camera.updateProjectionMatrix(),this._zoomState=this.camera.zoom):this.camera.isPerspectiveCamera&&(this._fovState=this.camera.fov)};updateTbState=(t,i)=>{this._state=t,i&&this.updateMatrixState()};update=()=>{if(!1===this.target.equals(this._currentTarget)&&(this._gizmos.position.copy(this.target),this._tbRadius=this.calculateTbRadius(this.camera),this.makeGizmos(this.target,this._tbRadius),this._currentTarget.copy(this.target)),this.camera.isOrthographicCamera)(this.camera.zoom>this.maxZoom||this.camera.zoom<this.minZoom)&&(t=MathUtils.clamp(this.camera.zoom,this.minZoom,this.maxZoom),this.applyTransformMatrix(this.scale(t/this.camera.zoom,this._gizmos.position,!0)));else if(this.camera.isPerspectiveCamera){var t=this.camera.position.distanceTo(this._gizmos.position),i=((t>this.maxDistance+1e-6||t<this.minDistance-1e-6)&&(i=MathUtils.clamp(t,this.minDistance,this.maxDistance),this.applyTransformMatrix(this.scale(i/t,this._gizmos.position)),this.updateMatrixState()),(this.camera.fov<this.minFov||this.camera.fov>this.maxFov)&&(this.camera.fov=MathUtils.clamp(this.camera.fov,this.minFov,this.maxFov),this.camera.updateProjectionMatrix()),this._tbRadius);if(this._tbRadius=this.calculateTbRadius(this.camera),i<this._tbRadius-1e-6||i>this._tbRadius+1e-6){var t=(this._gizmos.scale.x+this._gizmos.scale.y+this._gizmos.scale.z)/3,i=this._tbRadius/t,t=new EllipseCurve(0,0,i,i).getPoints(this._curvePts),s=(new BufferGeometry).setFromPoints(t);for(const e in this._gizmos.children)this._gizmos.children[e].geometry=s}}this.camera.lookAt(this._gizmos.position)};setStateFromJSON=t=>{var t=JSON.parse(t);null!=t.arcballState&&(this._cameraMatrixState.fromArray(t.arcballState.cameraMatrix.elements),this._cameraMatrixState.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.camera.up.copy(t.arcballState.cameraUp),this.camera.near=t.arcballState.cameraNear,this.camera.far=t.arcballState.cameraFar,this.camera.zoom=t.arcballState.cameraZoom,this.camera.isPerspectiveCamera&&(this.camera.fov=t.arcballState.cameraFov),this._gizmoMatrixState.fromArray(t.arcballState.gizmoMatrix.elements),this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this.camera.updateMatrix(),this.camera.updateProjectionMatrix(),this._gizmos.updateMatrix(),this._tbRadius=this.calculateTbRadius(this.camera),t=(new Matrix4).copy(this._gizmoMatrixState0),this.makeGizmos(this._gizmos.position,this._tbRadius),this._gizmoMatrixState0.copy(t),this.camera.lookAt(this._gizmos.position),this.updateTbState(STATE.IDLE,!1),this.dispatchEvent(_changeEvent))}}export{ArcballControls};